<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deutsch-Test — Lehrerbereich mit Firebase</title>
  <style>
    body{font-family:Inter,system-ui;background:#f4f7fb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(12,24,48,0.06)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{color:#0b63d6;font-size:20px;margin:0}
    .small{font-size:12px;color:#667}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eaeaea;padding:6px;text-align:left;font-size:12px;vertical-align:top}
    th{background:#f0f4ff}
    button{background:#0b63d6;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}
    input[type=password], input[type=text]{padding:8px;border:1px solid #ccc;border-radius:6px;width:240px}
    #teacherPanel{display:none;margin-top:14px;padding:12px;background:#fff8e6;border-radius:8px;border:1px solid #ffecb3}
    .task{margin:12px 0;padding:10px;border:1px solid #eef3ff;border-radius:10px;background:#fbfdff}
    .task p{margin:0 0 6px 0;font-weight:600}
    label{display:block;margin:4px 0}
    .ok{color:#16a34a;font-weight:600}
    .bad{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Deutsch-Test — Lehrerbereich</h1>
      <div class="small">Wortarten · Satzzeichen · Zeitformen</div>
    </header>

    <div id="studentArea" style="margin-top:20px;">
      <p>Trage deinen Namen ein und bearbeite die Aufgaben:</p>
      <input type="text" id="studentName" placeholder="Vorname Nachname">
      <div id="tasks"></div>
      <button id="submitBtn">Antworten absenden</button>
      <div id="resultBox" class="small" style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:#f0f7ff;border:1px solid #dbeeff"></div>
    </div>

    <div id="loginArea" style="margin-top:28px;">
      <p>Bitte Passwort eingeben, um den Lehrerbereich zu öffnen:</p>
      <input type="password" id="teacherPass" placeholder="Lehrerpasswort">
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="small" style="color:#b33;margin-top:8px;"></div>
    </div>

    <div id="teacherPanel">
      <button id="refreshSub" class="secondary">Aktualisieren</button>
      <div id="submissionsContainer" style="margin-top:14px"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOWi7ecJR17wzEsm2q6wPR1BZWV-VrDBo",
  authDomain: "hausaufgabe-40294.firebaseapp.com",
  projectId: "hausaufgabe-40294",
  storageBucket: "hausaufgabe-40294.firebasestorage.app",
  messagingSenderId: "275544438191",
  appId: "1:275544438191:web:d68f43e7e43025df76eb5a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Aufgaben Deutsch (Wortarten, Satzzeichen, Zeitformen) ----------
const tasks = [
  {id:1, points:1, question:"Welche Wortart ist 'laufen'?", type:"single", options:["Verb","Nomen","Adjektiv"]},
  {id:2, points:1, question:"Welche Wortart ist 'schön'?", type:"single", options:["Verb","Adjektiv","Pronomen"]},
  {id:3, points:1, question:"Welche Wörter sind Nomen?", type:"multi", options:["Haus","blau","laufen","Kind"]},
  {id:4, points:1, question:"Welche Wörter sind Verben?", type:"multi", options:["gehen","Haus","rennen","schnell"]},
  {id:5, points:1, question:"Welche Wortart ist 'ich'?", type:"single", options:["Pronomen","Adjektiv","Verb"]},
  {id:6, points:1, question:"Welche Satzzeichen gehören ans Satzende?", type:"multi", options:[".","!","?"]},
  {id:7, points:1, question:"Welche Satzzeichen benutzt man bei einem Fragesatz?", type:"single", options:[".","?","!"]},
  {id:8, points:1, question:"Welche Satzzeichen benutzt man bei einem Ausrufesatz?", type:"single", options:[".","!","?"]},
  {id:9, points:1, question:"Wähle alle Zeitformen des Verbs: 'ich gehe'", type:"multi", options:["ich gehe","ich ging","ich bin gegangen","ich war gegangen","ich werde gehen","ich werde gegangen sein"]},
  {id:10, points:1, question:"'ich aß' steht im …", type:"single", options:["Präsens","Präteritum","Perfekt","Plusquamperfekt"]},
  {id:11, points:1, question:"'ich habe gespielt' steht im …", type:"single", options:["Perfekt","Präteritum","Plusquamperfekt","Futur I"]},
  {id:12, points:1, question:"'ich war gelaufen' steht im …", type:"single", options:["Plusquamperfekt","Perfekt","Präteritum","Futur II"]},
  {id:13, points:1, question:"'ich werde lernen' steht im …", type:"single", options:["Futur I","Präsens","Perfekt","Plusquamperfekt"]},
  {id:14, points:1, question:"'ich werde gegangen sein' steht im …", type:"single", options:["Futur II","Perfekt","Präteritum","Plusquamperfekt"]},
  {id:15, points:1, question:"Welche Wörter sind Adjektive?", type:"multi", options:["schnell","blau","laufen","Auto","freundlich"]},
  {id:16, points:1, question:"Welche Wortart beschreibt Tätigkeiten?", type:"single", options:["Verb","Nomen","Adjektiv"]},
  {id:17, points:1, question:"Welche Wortart beschreibt Eigenschaften?", type:"single", options:["Adjektiv","Nomen","Verb"]},
  {id:18, points:1, question:"Welche Zeitform hat das Verb: 'Er wird morgen arbeiten.'", type:"single", options:["Futur I","Präsens","Perfekt"]},
  {id:19, points:1, question:"Welche Zeitform hat das Verb: 'Sie hat den Ball gefangen.'", type:"single", options:["Perfekt","Präteritum","Plusquamperfekt"]},
  {id:20, points:1, question:"Welche Zeitform hat das Verb: 'Er war im Kino gewesen.'", type:"single", options:["Plusquamperfekt","Perfekt","Futur II"]},
  {id:21, points:1, question:"Wähle alle richtigen Schreibweisen eines Aussagesatzes.", type:"multi", options:["Ich mag Pizza.","ich mag Pizza","Ich mag pizza!","Ich mag Pizza!"]},
  {id:22, points:1, question:"Welche Wörter sind Pronomen?", type:"multi", options:["ich","du","er","Auto","laufen"]},
  {id:23, points:1, question:"Welche Zeitform: 'Wir schreiben einen Brief.'", type:"single", options:["Präsens","Perfekt","Futur I"]},
  {id:24, points:1, question:"Welche Zeitform: 'Wir schrieben einen Brief.'", type:"single", options:["Präteritum","Perfekt","Präsens"]},
  {id:25, points:1, question:"Welche Zeitform: 'Wir haben einen Brief geschrieben.'", type:"single", options:["Perfekt","Präteritum","Plusquamperfekt"]}
];

const answerKey = {
  1:{type:"single",correct:["Verb"]},
  2:{type:"single",correct:["Adjektiv"]},
  3:{type:"multi",correct:["Haus","Kind"]},
  4:{type:"multi",correct:["gehen","rennen"]},
  5:{type:"single",correct:["Pronomen"]},
  6:{type:"multi",correct:[".","!","?"]},
  7:{type:"single",correct:["?"]},
  8:{type:"single",correct:["!"]},
  9:{type:"multi",correct:["ich gehe","ich ging","ich bin gegangen","ich war gegangen","ich werde gehen","ich werde gegangen sein"]},
  10:{type:"single",correct:["Präteritum"]},
  11:{type:"single",correct:["Perfekt"]},
  12:{type:"single",correct:["Plusquamperfekt"]},
  13:{type:"single",correct:["Futur I"]},
  14:{type:"single",correct:["Futur II"]},
  15:{type:"multi",correct:["schnell","blau","freundlich"]},
  16:{type:"single",correct:["Verb"]},
  17:{type:"single",correct:["Adjektiv"]},
  18:{type:"single",correct:["Futur I"]},
  19:{type:"single",correct:["Perfekt"]},
  20:{type:"single",correct:["Plusquamperfekt"]},
  21:{type:"multi",correct:["Ich mag Pizza."]},
  22:{type:"multi",correct:["ich","du","er"]},
  23:{type:"single",correct:["Präsens"]},
  24:{type:"single",correct:["Präteritum"]},
  25:{type:"single",correct:["Perfekt"]}
};

// ------------------- Bewertung & Anzeige -------------------
const tasksById = Object.fromEntries(tasks.map(t=>[t.id,t]));
function normalize(s){ return String(s||'').trim().toLowerCase(); }
function arraysEqualAsSets(a,b){
  const A=new Set(a.map(normalize)),B=new Set(b.map(normalize));
  return A.size===B.size && [...A].every(v=>B.has(v));
}
function isCorrect(id,g){
  const spec=answerKey[id]; if(!spec)return false;
  if(spec.type==="multi"){return arraysEqualAsSets(Array.isArray(g)?g:[],spec.correct);}
  return spec.correct.map(normalize).includes(normalize(g));
}
function autoPoints(id,g){return isCorrect(id,g)?(tasksById[id].points||1):0;}
function totalMaxPoints(){return tasks.reduce((s,t)=>s+t.points,0);}

const tasksDiv=document.getElementById("tasks");
tasks.forEach(t=>{
  const d=document.createElement("div"); d.className="task";
  const p=document.createElement("p"); p.textContent=`${t.id}. ${t.question} (${t.points} P)`; d.appendChild(p);
  if(t.type==="single"){
    t.options.forEach(opt=>{
      const l=document.createElement("label");
      const i=document.createElement("input"); i.type="radio"; i.name="a"+t.id; i.value=opt;
      l.appendChild(i); l.append(" "+opt); d.appendChild(l);
    });
  } else if(t.type==="multi"){
    t.options.forEach(opt=>{
      const l=document.createElement("label");
      const i=document.createElement("input"); i.type="checkbox"; i.name="a"+t.id; i.value=opt;
      l.appendChild(i); l.append(" "+opt); d.appendChild(l);
    });
  }
  tasksDiv.appendChild(d);
});
tasksDiv.insertAdjacentHTML("beforeend",`<div class="small">Gesamtpunkte: ${totalMaxPoints()}</div>`);

const submitBtn=document.getElementById("submitBtn"),resultBox=document.getElementById("resultBox");
submitBtn.addEventListener("click",async()=>{
  const name=document.getElementById("studentName").value.trim();
  if(!name)return alert("Bitte Namen eingeben!");
  const answers={};
  for(const t of tasks){
    const key="a"+t.id;
    if(t.type==="multi")answers[key]=[...document.querySelectorAll(`input[name="${key}"]:checked`)].map(x=>x.value);
    else answers[key]=document.querySelector(`input[name="${key}"]:checked`)?.value||"";
  }
  let sum=0; for(const t of tasks){sum+=autoPoints(t.id,answers["a"+t.id]);}
  const percent=Math.round(sum/totalMaxPoints()*100);
  try{
    await addDoc(collection(db,"submissions"),{studentName:name,answers,score:sum,percent,createdAt:serverTimestamp()});
    resultBox.style.display="block";
    resultBox.innerHTML=`<strong>Abgabe gespeichert:</strong> ${sum}/${totalMaxPoints()} Punkte (${percent} %)`;
  }catch(e){console.error(e);alert("Fehler beim Speichern.");}
});

const TEACHER_PASSWORD="lehrer123";
document.getElementById("loginBtn").addEventListener("click",async()=>{
  if(document.getElementById("teacherPass").value!==TEACHER_PASSWORD)return document.getElementById("loginMsg").textContent="Falsches Passwort!";
  document.getElementById("loginArea").style.display="none";
  document.getElementById("teacherPanel").style.display="block";
  const subC=document.getElementById("submissionsContainer");
  let snap;
  try{snap=await getDocs(query(collection(db,"submissions"),orderBy("createdAt","desc")));}catch{snap=await getDocs(collection(db,"submissions"));}
  if(snap.empty)return subC.textContent="Keine Einsendungen.";
  let html="<table><tr><th>Name</th><th>Punkte</th><th>%</th></tr>";
  snap.forEach(d=>{
    const x=d.data();
    html+=`<tr><td>${x.studentName}</td><td>${x.score}</td><td>${x.percent}</td></tr>`;
  });
  subC.innerHTML=html+"</table>";
});
</script>
</body>
</html>
