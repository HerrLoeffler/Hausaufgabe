<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wortarten-Test — Lehrerbereich mit Firebase</title>
  <style>
    body{font-family:Inter,system-ui;background:#f4f7fb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(12,24,48,0.06)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{color:#0b63d6;font-size:20px;margin:0}
    .small{font-size:12px;color:#667}

    /* Lehrerbereich kompakter & linksbündig */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eaeaea;padding:6px;text-align:left;font-size:12px;vertical-align:top}
    th{background:#f0f4ff}

    button{background:#0b63d6;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}
    button.secondary{background:#eef6ff;color:#0b63d6;border:1px solid #d6eaff}
    input[type=password], input[type=text]{padding:8px;border:1px solid #ccc;border-radius:6px;width:240px}
    #teacherPanel{display:none;margin-top:14px;padding:12px;background:#fff8e6;border-radius:8px;border:1px solid #ffecb3}
    .task{margin:12px 0;padding:10px;border:1px solid #eef3ff;border-radius:10px;background:#fbfdff}
    .task p{margin:0 0 6px 0;font-weight:600}
    label{display:block;margin:4px 0}

    /* Anzeige/Editor in Q-Zellen */
    .pts-line{display:flex;align-items:center;gap:6px;margin-top:6px}
    .q-pts-label{font-size:11px;color:#445;white-space:nowrap}
    .q-pts{width:52px;padding:3px 6px;border:1px solid #ccd6e6;border-radius:6px;text-align:center;font-size:12px}

    /* Spaltenbreiten (breit aber kompakt) */
    .col-name{width:150px}
    .col-q{min-width:120px;width:120px}
    .col-sum{width:88px}
    .col-pc{width:60px}
    .col-note{width:60px}
    .col-time{width:160px}
    .col-act{width:260px}

    /* Antworten: links, Zeilenumbruch statt Überlappung, Höhe begrenzt */
    .ans{white-space:normal;word-break:break-word;max-height:70px;overflow:auto}

    .save-btn{background:#16a34a;border:1px solid #b7f0c2;color:#fff;padding:6px 10px;border-radius:8px;margin-left:4px}
    .view-btn{background:#5551ff;border:1px solid #cfd2ff;color:#fff;padding:6px 10px;border-radius:8px;margin-left:4px}
    .edit-btn{background:#0ea5e9;border:1px solid #bfe6fb;color:#fff;padding:6px 10px;border-radius:8px;margin-left:4px}
    .global-edit{background:#0ea5e9;border:1px solid #bfe6fb}

    /* Modal */
    #modalOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;padding:16px}
    #modalCard{max-width:920px;width:100%;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);padding:16px}
    #modalBody{max-height:70vh;overflow:auto}
    #modalHeader{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    #closeModal{margin-left:auto;background:#e11d48}
    .ok{color:#16a34a;font-weight:600}
    .bad{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Wortarten-Test — Lehrerbereich</h1>
      <div class="small">Abruf aller Einsendungen aus Firebase</div>
    </header>

    <div id="studentArea" style="margin-top:20px;">
      <p>Trage deinen Namen ein und bearbeite die Aufgaben:</p>
      <input type="text" id="studentName" placeholder="Vorname Nachname">
      <div id="tasks"></div>
      <button id="submitBtn">Antworten absenden</button>
      <div id="resultBox" class="small" style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:#f0f7ff;border:1px solid #dbeeff"></div>
    </div>

    <div id="loginArea" style="margin-top:28px;">
      <p>Bitte Passwort eingeben, um den Lehrerbereich zu öffnen:</p>
      <input type="password" id="teacherPass" placeholder="Lehrerpasswort">
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="small" style="color:#b33;margin-top:8px;"></div>
    </div>

    <div id="teacherPanel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="refreshSub" class="secondary">Aktualisieren</button>
        <button id="exportCsv" class="secondary">Export CSV</button>
        <button id="toggleAllEdit" class="global-edit">Alle Punkte editieren</button>
        <div class="small" style="margin-left:auto">Linksgebunden • Edit-Modus pro Zeile oder global</div>
      </div>
      <div id="submissionsContainer" style="margin-top:14px"></div>
    </div>
  </div>

  <!-- Modal für Detailansicht -->
  <div id="modalOverlay">
    <div id="modalCard">
      <div id="modalHeader">
        <h2 style="margin:0;font-size:18px;color:#0b63d6">Abgabe – Detailansicht</h2>
        <button id="closeModal">Schließen</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// ---- Firebase ----
const firebaseConfig = {
  apiKey: "AIzaSyCOWi7ecJR17wzEsm2q6wPR1BZWV-VrDBo",
  authDomain: "hausaufgabe-40294.firebaseapp.com",
  projectId: "hausaufgabe-40294",
  storageBucket: "hausaufgabe-40294.firebasestorage.app",
  messagingSenderId: "275544438191",
  appId: "1:275544438191:web:d68f43e7e43025df76eb5a",
  measurementId: "G-HPGHMYZXNJ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---- 30 Aufgaben (klar & mittelstufengerecht) ----
const tasks = [
  {id:1,  points:1, type:"multi",  question:"Markiere alle Nomen: Die Katze schläft auf dem Sofa.", options:["Katze","schläft","Sofa","auf"]},
  {id:2,  points:1, type:"single", question:"Welche Wortart ist „laufen“?", options:["Nomen","Verb","Adjektiv"]},
  {id:3,  points:1, type:"multi",  question:"Wähle alle Adjektive:", options:["schnell","blau","gehen","Auto"]},
  {id:4,  points:1, type:"single", question:"Welche Wortart ist „heute“?", options:["Adverb","Nomen","Verb"]},
  {id:5,  points:1, type:"multi",  question:"Wähle alle Präpositionen:", options:["unter","wegen","Kind","spielen","über"]},
  {id:6,  points:1, type:"multi",  question:"Wähle alle Konjunktionen:", options:["und","oder","aber","Auto","weil"]},
  {id:7,  points:1, type:"single", question:"Welche Wortart ist „drei“?", options:["Numerale","Adverb","Adjektiv"]},
  {id:8,  points:1, type:"multi",  question:"Markiere Personalpronomen: Ich sehe dich, er wartet.", options:["Ich","dich","er","wartet"]},
  {id:9,  points:1, type:"multi",  question:"Wähle Possessivpronomen:", options:["mein","dein","sein","Hund","bunt"]},
  {id:10, points:1, type:"single", question:"Welche Wortart ist „dieser“ (als Hinweiswort)?", options:["Demonstrativpronomen","Personalpronomen","Nomen"]},
  {id:11, points:1, type:"single", question:"Relativpronomen erkennen: „Das ist die Schülerin, ___ gestern gefehlt hat.“", options:["die","jenes","wir"]},
  {id:12, points:1, type:"single", question:"Welche Wortart ist „unter“?", options:["Präposition","Konjunktion","Adverb"]},
  {id:13, points:1, type:"single", question:"Welche Wortart ist „weil“?", options:["Konjunktion","Adverb","Numerale"]},
  {id:14, points:1, type:"single", question:"Welche Wortart ist „sieben“?", options:["Numerale","Adjektiv","Nomen"]},
  {id:15, points:1, type:"text",  question:"Setze ein passendes Adjektiv ein: Das Essen war ___. (z. B. lecker)",},
  {id:16, points:1, type:"multi",  question:"Welche Wörter sind Nomen?", options:["Freude","laufen","schnell","Tisch"]},
  {id:17, points:1, type:"multi",  question:"Welche Wörter sind Verben?", options:["gehen","spielen","lieb","Haus"]},
  {id:18, points:1, type:"multi",  question:"Welche Wörter sind Adjektive?", options:["klug","rot","gestern","laufen"]},
  {id:19, points:1, type:"multi",  question:"Welche Wörter sind Adverbien?", options:["gestern","dort","schön","spielen"]},
  {id:20, points:1, type:"single", question:"Welche Wortart ist „und“?", options:["Konjunktion","Präposition","Adverb"]},
  {id:21, points:1, type:"single", question:"Welche Wortart ist „ohne“?", options:["Präposition","Konjunktion","Verb"]},
  {id:22, points:1, type:"single", question:"Pronomenart in „Das ist sein Fahrrad.“ — „sein“ ist …", options:["Possessivpronomen","Personalpronomen","Demonstrativpronomen"]},
  {id:23, points:1, type:"single", question:"Pronomenart in „Dieses Buch gehört Anna.“ — „Dieses“ ist …", options:["Demonstrativpronomen","Relativpronomen","Personalpronomen"]},
  {id:24, points:1, type:"single", question:"Pronomenart in „Das ist der Mann, der hilft.“ — „der“ (2.) ist …", options:["Relativpronomen","Possessivpronomen","Adjektiv"]},
  {id:25, points:1, type:"single", question:"Pronomenart in „Ich komme später.“ — „Ich“ ist …", options:["Personalpronomen","Relativpronomen","Demonstrativpronomen"]},
  {id:26, points:1, type:"text",  question:"Setze das Personalpronomen (3. Person Plural, Nominativ): ___ kommen später."},
  {id:27, points:1, type:"multi",  question:"Welche Konjunktionen verbinden gleichrangige Sätze/Wörter?", options:["und","oder","aber","weil","dass"]},
  {id:28, points:1, type:"multi",  question:"Welche Präpositionen verlangen in der Regel den Dativ?", options:["mit","aus","für","ohne"]},
  {id:29, points:1, type:"multi",  question:"Wähle alle Demonstrativpronomen:", options:["dieser","jene","solches","wir","mein"]},
  {id:30, points:1, type:"multi",  question:"Wähle alle Possessivpronomen:", options:["mein","unser","euer","dieser","sie"]}
];

// ---- Antwortschlüssel (einfach & eindeutig) ----
const answerKey = {
  1:  {type:'multi',  correct:["Katze","Sofa"]},
  2:  {type:'single', correct:["Verb"]},
  3:  {type:'multi',  correct:["schnell","blau"]},
  4:  {type:'single', correct:["Adverb"]},
  5:  {type:'multi',  correct:["unter","wegen","über"]},
  6:  {type:'multi',  correct:["und","oder","aber","weil"]},
  7:  {type:'single', correct:["Numerale"]},
  8:  {type:'multi',  correct:["Ich","dich","er"]},
  9:  {type:'multi',  correct:["mein","dein","sein"]},
  10: {type:'single', correct:["Demonstrativpronomen"]},
  11: {type:'single', correct:["die"]},
  12: {type:'single', correct:["Präposition"]},
  13: {type:'single', correct:["Konjunktion"]},
  14: {type:'single', correct:["Numerale"]},
  15: {type:'text',  correct:["lecker","gut","schlecht","würzig","kalt","heiß","fettig","salzig","süß","bitter","sauer"]},
  16: {type:'multi',  correct:["Freude","Tisch"]},
  17: {type:'multi',  correct:["gehen","spielen"]},
  18: {type:'multi',  correct:["klug","rot"]},
  19: {type:'multi',  correct:["gestern","dort"]},
  20: {type:'single', correct:["Konjunktion"]},
  21: {type:'single', correct:["Präposition"]},
  22: {type:'single', correct:["Possessivpronomen"]},
  23: {type:'single', correct:["Demonstrativpronomen"]},
  24: {type:'single', correct:["Relativpronomen"]},
  25: {type:'single', correct:["Personalpronomen"]},
  26: {type:'text',  correct:["sie"]},  // 3. Person Plural Nominativ
  27: {type:'multi',  correct:["und","oder","aber"]},
  28: {type:'multi',  correct:["mit","aus"]},
  29: {type:'multi',  correct:["dieser","jene","solches"]},
  30: {type:'multi',  correct:["mein","unser","euer"]}
};

// ---- Hilfsstrukturen & Bewertung (unverändert) ----
const tasksById = Object.fromEntries(tasks.map(t=>[t.id,t]));
function normalize(s){ return String(s||'').trim().toLowerCase(); }
function arraysEqualAsSets(a,b){
  if(a.length!==b.length) return false;
  const A=new Set(a.map(normalize));
  const B=new Set(b.map(normalize));
  if(A.size!==B.size) return false;
  for(const v of A){ if(!B.has(v)) return false; }
  return true;
}
function totalMaxPoints(){ return tasks.reduce((s,t)=>s+(Number(t.points)||0),0); }
function isCorrect(taskId, given){
  const spec = answerKey[taskId];
  if(!spec) return false;
  if(spec.type==='multi'){
    const g = Array.isArray(given)? given.map(normalize) : [];
    return arraysEqualAsSets(g, spec.correct.map(normalize));
  } else if(spec.type==='single'){
    return spec.correct.map(normalize).includes(normalize(given));
  } else {
    return spec.correct.map(normalize).includes(normalize(given));
  }
}
function autoPoints(taskId, given){
  const t = tasksById[taskId];
  return isCorrect(taskId, given) ? (Number(t.points)||0) : 0;
}

// ---- Schüler-Rendering (zeigt Punkte je Aufgabe) ----
const tasksDiv = document.getElementById('tasks');
function renderTasks(){
  tasksDiv.innerHTML = '';
  tasks.forEach(t=>{
    const div = document.createElement('div');
    div.className='task';
    const p = document.createElement('p');
    const ptsLabel = ` (${t.points} Punkt${t.points===1?'':'e'})`;
    p.textContent = `${t.id}. ${t.question}${ptsLabel}`;
    div.appendChild(p);

    if(t.type==='multi'){
      const opts = [...t.options];
      for(let i=opts.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [opts[i],opts[j]]=[opts[j],opts[i]]; }
      opts.forEach(opt=>{
        const lbl = document.createElement('label');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.name='a'+t.id; cb.value=opt;
        lbl.appendChild(cb); lbl.appendChild(document.createTextNode(' '+opt));
        div.appendChild(lbl);
      });
    } else if(t.type==='single'){
      const opts = [...t.options];
      for(let i=opts.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [opts[i],opts[j]]=[opts[j],opts[i]]; }
      opts.forEach(opt=>{
        const lbl = document.createElement('label');
        const rb = document.createElement('input'); rb.type='radio'; rb.name='a'+t.id; rb.value=opt;
        lbl.appendChild(rb); lbl.appendChild(document.createTextNode(' '+opt));
        div.appendChild(lbl);
      });
    } else {
      const input = document.createElement('input'); input.type='text'; input.name='a'+t.id; input.placeholder='Antwort eingeben';
      div.appendChild(input);
    }

    tasksDiv.appendChild(div);
  });

  const totalPts = totalMaxPoints();
  const info = document.createElement('div');
  info.className = 'small';
  info.style.marginTop = '6px';
  info.textContent = `Gesamtpunkte: ${totalPts}`;
  tasksDiv.appendChild(info);
}
renderTasks();

// ---- Notenschlüssel ----
function gradeFromPercent(p){
  const n = Number(p)||0;
  if(n>=91) return 1;
  if(n>=77) return 2;
  if(n>=57) return 3;
  if(n>=39) return 4;
  if(n>=25) return 5;
  return 6;
}

// ---- Auswertung gesamt ----
function evaluateAll(answers){
  const details=[];
  let sum=0;
  for(const t of tasks){
    const key='a'+t.id;
    const given = answers[key];
    const ok = isCorrect(t.id, given);
    const ptsIfCorrect = Number(t.points)||0;
    const auto = ok ? ptsIfCorrect : 0;
    sum += auto;
    details.push({id:t.id, q:t.question, given, correct:answerKey[t.id].correct, ok, pointsIfCorrect:ptsIfCorrect, autoAward:auto});
  }
  const maxPts = totalMaxPoints();
  const percent = maxPts>0 ? Math.round(sum/maxPts*100) : 0;
  return {points:sum, maxPts, percent, details};
}

// ---- Abgabe (Bestätigung & Lock) ----
const submitBtn = document.getElementById('submitBtn');
const resultBox = document.getElementById('resultBox');
submitBtn.addEventListener('click', handleSubmitClick);

function countUnanswered(){
  let missing=0;
  for(const t of tasks){
    const key='a'+t.id;
    if(t.type==='multi'){
      const vals = Array.from(document.querySelectorAll(`input[name="${key}"]:checked`));
      if(vals.length===0) missing++;
    } else if(t.type==='single'){
      const val = document.querySelector(`input[name="${key}"]:checked`);
      if(!val) missing++;
    } else {
      const val = document.querySelector(`input[name="${key}"]`)?.value.trim();
      if(!val) missing++;
    }
  }
  return missing;
}
function lockStudentForm(){
  document.getElementById('studentName').setAttribute('disabled','disabled');
  tasksDiv.querySelectorAll('input').forEach(el=>el.setAttribute('disabled','disabled'));
  submitBtn.setAttribute('disabled','disabled');
  submitBtn.textContent = 'Abgegeben';
}

async function handleSubmitClick(){
  const name = document.getElementById('studentName').value.trim();
  if(!name){ alert('Bitte Namen eingeben!'); return; }

  const missing = countUnanswered();
  const total = tasks.length;
  const confirmMsg = missing>0
    ? `Du hast ${missing} von ${total} Aufgaben nicht bearbeitet.\nWirklich absenden? Danach kannst du nichts mehr ändern.`
    : `Möchtest du deine Antworten wirklich absenden? Danach kannst du nichts mehr ändern.`;
  if(!confirm(confirmMsg)){ return; }

  lockStudentForm();

  const answers = {};
  for(const t of tasks){
    const key = 'a'+t.id;
    if(t.type==='multi'){
      const vals = Array.from(document.querySelectorAll(`input[name="${key}"]:checked`)).map(c=>c.value);
      answers[key] = vals;
    } else if(t.type==='single'){
      const val = document.querySelector(`input[name="${key}"]:checked`)?.value || '';
      answers[key] = val;
    } else {
      const val = document.querySelector(`input[name="${key}"]`)?.value || '';
      answers[key] = val;
    }
  }

  const evalRes = evaluateAll(answers);

  try{
    await addDoc(collection(db,'submissions'),{
      studentName: name,
      answers,
      score: evalRes.points,
      maxPoints: evalRes.maxPts,
      percent: evalRes.percent,
      createdAt: serverTimestamp(),
      createdAtLocal: new Date().toISOString()
    });

    resultBox.style.display='block';
    let html = `<strong>Abgabe gespeichert</strong> — ${evalRes.points}/${evalRes.maxPts} Punkte (${evalRes.percent}%).`;
    html += `<details style="margin-top:8px"><summary>Antworten & Lösungen ansehen</summary>`;
    evalRes.details.forEach(d=>{
      const given = Array.isArray(d.given)? d.given.join(', ') : (d.given||'(leer)');
      const correct = Array.isArray(d.correct)? d.correct.join(', ') : d.correct;
      html += `<div style="margin-top:6px;padding:8px;border:1px solid #eef3ff;border-radius:8px;background:#fff">`+
              `<div style="font-weight:600">${d.id}. ${d.q} — <span class="small">${d.pointsIfCorrect} Punkt${d.pointsIfCorrect===1?'':'e'}</span></div>`+
              `<div>Deine Antwort: ${escapeHtml(given)} ${d.ok? '<span class="ok">✅ richtig</span>' : '<span class="bad">❌ falsch</span>'}</div>`+
              `<div>Korrekt: ${escapeHtml(String(correct))}</div>`+
              `</div>`;
    });
    html += `</details>`;
    resultBox.innerHTML = html;

  }catch(err){
    console.error('Fehler beim Speichern:', err);
    alert('Fehler beim Speichern. Siehe Konsole.');
    document.getElementById('studentName').removeAttribute('disabled');
    tasksDiv.querySelectorAll('input').forEach(el=>el.removeAttribute('disabled'));
    submitBtn.removeAttribute('disabled');
    submitBtn.textContent = 'Antworten absenden';
  }
}

// ---- Lehrerbereich ----
const TEACHER_PASSWORD='lehrer123';
const loginBtn=document.getElementById('loginBtn');
const loginMsg=document.getElementById('loginMsg');
const teacherPanel=document.getElementById('teacherPanel');
const submissionsContainer=document.getElementById('submissionsContainer');
const toggleAllBtn=document.getElementById('toggleAllEdit');

loginBtn.addEventListener('click',()=>{
  const entered=document.getElementById('teacherPass').value;
  if(entered===TEACHER_PASSWORD){
    document.getElementById('loginArea').style.display='none';
    teacherPanel.style.display='block';
    refreshSubmissions();
  } else {
    loginMsg.textContent='Falsches Passwort!';
  }
});

document.getElementById('refreshSub').addEventListener('click', refreshSubmissions);
document.getElementById('exportCsv').addEventListener('click', exportCsv);

// ---- Lehrer-Tabelle mit globalem Edit-Schalter ----
async function refreshSubmissions(){
  submissionsContainer.innerHTML='<div class="small">Lade Einsendungen…</div>';
  try{
    let snap;
    try{
      snap = await getDocs(query(collection(db,'submissions'), orderBy('createdAt','desc')));
    }catch(e){
      console.warn('Fallback ohne orderBy(createdAt):', e);
      snap = await getDocs(collection(db,'submissions'));
    }

    if(snap.empty){ submissionsContainer.innerHTML='<div class="small">Keine Einsendungen gefunden.</div>'; return; }

    const maxPtsNow = totalMaxPoints();

    let html = '<table><thead><tr>';
    html += `<th class="col-name">Name</th>`;
    for(let i=1;i<=tasks.length;i++){ html += `<th class="col-q">Q${i}<br><span class="small">Antwort / P.</span></th>`; }
    html += '<th class="col-sum">Gesamt</th><th class="col-pc">%</th><th class="col-note">Note</th><th class="col-time">Zeit</th><th class="col-act">Aktion</th></tr></thead><tbody>';

    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const id = docSnap.id;

      const ans = d.answers || {};
      const tPts = d.teacherPoints || {}; // { "1": 1, ... }

      let rowHtml = `<tr data-doc="${id}" data-max="${d.maxPoints ?? maxPtsNow}"><td class="col-name">${escapeHtml(d.studentName||'')}</td>`;
      let sumPoints = 0;

      for(let q=1; q<=tasks.length; q++){
        const key = 'a'+q;
        const given = ans[key];
        const givenStr = Array.isArray(given)? given.join(', ') : (given||'');
        const defaultAuto = autoPoints(q, given);
        const value = (tPts[String(q)]!=null) ? tPts[String(q)] : defaultAuto;
        sumPoints += Number(value)||0;
        const ok = isCorrect(q, given);
        const okBadge = ok ? '<span class="ok">✅</span>' : '<span class="bad">❌</span>';

        // Anzeige-Modus (Spans) – Inputs erst bei Edit
        rowHtml += `<td class="col-q">
          <div class="ans">${escapeHtml(givenStr||'(leer)')} ${okBadge}</div>
          <div class="pts-line">
            <span class="q-pts-label">P:</span>
            <span class="pts-display" data-q="${q}">${String(value)}</span> / <span>${tasksById[q].points}</span>
          </div>
        </td>`;
      }

      const maxPts = d.maxPoints!=null ? d.maxPoints : maxPtsNow;
      const percent = maxPts>0 ? Math.round((sumPoints/maxPts)*100) : 0;
      const note = gradeFromPercent(percent);
      const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate()
                : (d.timestamp && d.timestamp.seconds ? new Date(d.timestamp.seconds*1000)
                : (d.createdAtLocal ? new Date(d.createdAtLocal) : null));

      rowHtml += `<td class="col-sum sum-cell">${escapeHtml(String(sumPoints))}</td>`;
      rowHtml += `<td class="col-pc pc-cell">${escapeHtml(String(percent))}</td>`;
      rowHtml += `<td class="col-note note-cell">${escapeHtml(String(note))}</td>`;
      rowHtml += `<td class="col-time">${ts? escapeHtml(ts.toLocaleString()) : ''}</td>`;
      rowHtml += `<td class="col-act">
        <button class="view-btn" data-doc="${id}">Anzeigen</button>
        <button class="edit-btn" data-doc="${id}" data-mode="view">Punkte editieren</button>
        <button class="save-btn" data-doc="${id}">Speichern</button>
      </td></tr>`;

      html += rowHtml;
    });

    html += '</tbody></table>';
    html += `<div class="small" style="margin-top:8px">Tipp: Globaler Schalter oben („Alle Punkte editieren“) oder pro Zeile mit „Punkte editieren“.</div>`;
    submissionsContainer.innerHTML = html;

    // Wenn globaler Edit-Schalter aktiv war, nachladen → wieder aktivieren
    if(toggleAllBtn.dataset.mode==='edit'){ setAllRowsEdit(true); }

  }catch(err){
    console.error('Ladefehler:',err);
    submissionsContainer.innerHTML = '<div class="small">Fehler beim Laden der Einsendungen. Siehe Konsole.</div>';
  }
}

// Einzelzeilen-Editmodus umschalten
function toggleEditMode(row, toEdit){
  const modeBtn = row.querySelector('.edit-btn');
  const displays = row.querySelectorAll('.pts-display');
  if(toEdit){
    displays.forEach(span=>{
      const val = span.textContent.trim();
      const q = span.dataset.q;
      const input = document.createElement('input');
      input.className='q-pts';
      input.type='text';
      input.inputMode='decimal';
      input.value = val;
      input.setAttribute('data-q', q);
      span.replaceWith(input);
    });
    if(modeBtn){ modeBtn.textContent = 'Felder sperren'; modeBtn.setAttribute('data-mode','edit'); }
  }else{
    const inputs = row.querySelectorAll('input.q-pts');
    inputs.forEach(inp=>{
      const q = inp.dataset.q;
      const span = document.createElement('span');
      span.className='pts-display';
      span.setAttribute('data-q', q);
      span.textContent = inp.value;
      inp.replaceWith(span);
    });
    if(modeBtn){ modeBtn.textContent = 'Punkte editieren'; modeBtn.setAttribute('data-mode','view'); }
  }
}

// Globaler Edit-Schalter
const toggleAllBtn=document.getElementById('toggleAllEdit');
toggleAllBtn.addEventListener('click', ()=>{
  const toEdit = toggleAllBtn.dataset.mode!=='edit';
  setAllRowsEdit(toEdit);
  toggleAllBtn.dataset.mode = toEdit ? 'edit' : 'view';
  toggleAllBtn.textContent = toEdit ? 'Alle Felder sperren' : 'Alle Punkte editieren';
});

function setAllRowsEdit(toEdit){
  document.querySelectorAll('#submissionsContainer tbody tr').forEach(tr=>{
    toggleEditMode(tr, toEdit);
  });
}

// Anzeigen / Editieren / Speichern
submissionsContainer.addEventListener('click', async (e)=>{
  const viewBtn = e.target.closest('.view-btn');
  const editBtn = e.target.closest('.edit-btn');
  const saveBtn = e.target.closest('.save-btn');
  if(!viewBtn && !editBtn && !saveBtn) return;

  const row = (viewBtn||editBtn||saveBtn).closest('tr');
  const docId = (viewBtn||editBtn||saveBtn).dataset.doc;

  if(viewBtn){
    const name = row.querySelector('.col-name').textContent;
    let body = `<div class="small">Schüler/in: <strong>${escapeHtml(name)}</strong></div>`;
    body += `<div style="margin-top:6px">`;
    for(let q=1;q<=tasks.length;q++){
      const qCell = row.querySelectorAll('.col-q')[q-1];
      const ansText = qCell.querySelector('.ans')?.textContent || '';
      const ptsVal = qCell.querySelector('.pts-display')?.textContent || qCell.querySelector('.q-pts')?.value || '0';
      body += `<div style="margin:6px 0;padding:8px;border:1px solid #eef3ff;border-radius:8px;background:#fff">
        <div style="font-weight:600">${q}. ${escapeHtml(tasksById[q].question)} <span class="small">(${tasksById[q].points} P)</span></div>
        <div>${escapeHtml(ansText)}</div>
        <div>Punkte: <strong>${escapeHtml(ptsVal)}</strong> / ${tasksById[q].points}</div>
      </div>`;
    }
    body += `</div>`;
    openModal(body);
    return;
  }

  if(editBtn){
    const mode = editBtn.getAttribute('data-mode');
    toggleEditMode(row, mode==='view');
    return;
  }

  if(saveBtn){
    try{
      const teacherPoints = {};
      let sum = 0;

      const nodes = row.querySelectorAll('input.q-pts, .pts-display');
      for(const n of nodes){
        const q = n.dataset.q;
        const raw = ('value' in n) ? n.value : n.textContent;
        const val = Number((raw||'').toString().replace(',','.'));
        if(Number.isNaN(val) || val<0){ alert(`Bitte gültige Punkte für Q${q} eingeben (≥ 0).`); return; }
        teacherPoints[q] = val;
        sum += val;
      }

      const maxPts = totalMaxPoints();
      const percent = maxPts>0 ? Math.round((sum/maxPts)*100) : 0;

      await updateDoc(doc(db,'submissions',docId), {
        teacherPoints,
        score: sum,
        percent,
        maxPoints: maxPts
      });

      row.querySelector('.sum-cell').textContent = String(sum);
      row.querySelector('.pc-cell').textContent = String(percent);
      row.querySelector('.note-cell').textContent = String(gradeFromPercent(percent));

      if(row.querySelector('.edit-btn')?.getAttribute('data-mode')==='edit'){
        toggleEditMode(row,false);
      }
    }catch(err){
      console.error('Fehler beim Speichern:',err);
      alert('Fehler beim Speichern. Siehe Konsole.');
    }
  }
});

// Modal helpers
const modalOverlay = document.getElementById('modalOverlay');
const modalBody = document.getElementById('modalBody');
document.getElementById('closeModal').addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e)=>{ if(e.target===modalOverlay) closeModal(); });
function openModal(html){ modalBody.innerHTML = html; modalOverlay.style.display='flex'; }
function closeModal(){ modalOverlay.style.display='none'; modalBody.innerHTML=''; }

// CSV-Export
async function exportCsv(){
  try{
    let snap;
    try{ snap = await getDocs(query(collection(db,'submissions'), orderBy('createdAt','desc'))); }
    catch(e){ console.warn('CSV-Fallback ohne orderBy:',e); snap = await getDocs(collection(db,'submissions')); }

    if(snap.empty){ alert('Keine Einsendungen.'); return; }

    const maxPtsNow = totalMaxPoints();

    const rows = [['Name', ...Array.from({length:tasks.length},(_,i)=>`Q${i+1}`), 'Punkte', 'maxPunkte', 'Prozent', 'Note', 'Timestamp']];
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const row = [d.studentName || ''];
      for(let i=1;i<=tasks.length;i++){
        const v = d.answers ? d.answers['a'+i] : '';
        row.push(Array.isArray(d.answers['a'+i])? d.answers['a'+i].join('; ') : (v||''));
      }
      const maxPts = d.maxPoints!=null ? d.maxPoints : maxPtsNow;
      const pts = d.score!=null? d.score : '';
      const pc = d.percent!=null? d.percent : (maxPts>0 && pts!=='' ? Math.round(Number(pts)/maxPts*100) : '');
      const note = pc!=='' ? gradeFromPercent(pc) : '';
      const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString()
               : (d.timestamp && d.timestamp.seconds ? new Date(d.timestamp.seconds*1000).toISOString()
               : (d.createdAtLocal || ''));
      row.push(pts);
      row.push(maxPts);
      row.push(pc);
      row.push(note);
      row.push(ts);
      rows.push(row);
    });

    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='einsendungen_wortarten.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),4000);
  }catch(err){
    console.error('Exportfehler:',err); alert('Fehler beim Export. Siehe Konsole.');
  }
}

// Utils
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
</script>
</body>
</html>
