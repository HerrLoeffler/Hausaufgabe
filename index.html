<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deutsch-Test — Lehrerbereich mit Firebase</title>
  <style>
    body{font-family:Inter,system-ui;background:#f4f7fb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(12,24,48,0.06)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{color:#0b63d6;font-size:20px;margin:0}
    .small{font-size:12px;color:#667}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eaeaea;padding:6px;text-align:left;font-size:12px;vertical-align:top}
    th{background:#f0f4ff}
    button{background:#0b63d6;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}
    input[type=password], input[type=text]{padding:8px;border:1px solid #ccc;border-radius:6px;width:240px}
    #teacherPanel{display:none;margin-top:14px;padding:12px;background:#fff8e6;border-radius:8px;border:1px solid #ffecb3}
    .task{margin:12px 0;padding:10px;border:1px solid #eef3ff;border-radius:10px;background:#fbfdff}
    .task p{margin:0 0 6px 0;font-weight:600}
    label{display:block;margin:4px 0}
    .ok{color:#16a34a;font-weight:600}
    .bad{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Deutsch-Test — Lehrerbereich</h1>
      <div class="small">Wortarten · Verbformen · Zeitformen</div>
    </header>

    <div id="studentArea" style="margin-top:20px;">
      <p>Trage deinen Namen ein und bearbeite die Aufgaben:</p>
      <input type="text" id="studentName" placeholder="Vorname Nachname">
      <div id="tasks"></div>
      <button id="submitBtn">Antworten absenden</button>
      <div id="resultBox" class="small" style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:#f0f7ff;border:1px solid #dbeeff"></div>
    </div>

    <div id="loginArea" style="margin-top:28px;">
      <p>Bitte Passwort eingeben, um den Lehrerbereich zu öffnen:</p>
      <input type="password" id="teacherPass" placeholder="Lehrerpasswort">
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="small" style="color:#b33;margin-top:8px;"></div>
    </div>

    <div id="teacherPanel">
      <button id="refreshSub" class="secondary">Aktualisieren</button>
      <div id="submissionsContainer" style="margin-top:14px"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOWi7ecJR17wzEsm2q6wPR1BZWV-VrDBo",
  authDomain: "hausaufgabe-40294.firebaseapp.com",
  projectId: "hausaufgabe-40294",
  storageBucket: "hausaufgabe-40294.firebasestorage.app",
  messagingSenderId: "275544438191",
  appId: "1:275544438191:web:d68f43e7e43025df76eb5a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Aufgaben Deutsch (didaktisch aufgebaut) ----------
const tasks = [
  // Wortarten (Grundlage)
  {id:1, points:1, question:"Welche Wortart ist „laufen“?", type:"single", options:["Verb","Nomen","Adjektiv"]},
  {id:2, points:1, question:"Welche Wortart ist „freundlich“?", type:"single", options:["Adjektiv","Verb","Pronomen"]},
  {id:3, points:1, question:"Welche Wörter sind Nomen?", type:"multi", options:["der Tisch","laufen","die Freiheit","schnell"]},
  {id:4, points:1, question:"Welche Wörter sind Verben?", type:"multi", options:["spielen","singen","Auto","das Haus"]},
  {id:5, points:1, question:"Welche Wortart ersetzt ein Nomen?", type:"single", options:["Pronomen","Adverb","Artikel"]},

  // Verbformen / finite Verb
  {id:6, points:1, question:"In welchem Satz ist das Verb richtig gebeugt?", type:"single", options:["Wir gehen nach Hause.","Ich gehen nach Hause.","Du geht nach Hause."]},
  {id:7, points:1, question:"Welches Wort ist das finite Verb im Satz: „Morgen werden wir ins Kino gehen.“?", type:"single", options:["werden","gehen","Morgen"]},
  {id:8, points:1, question:"3. Person Singular Präsens von „lesen“ lautet …", type:"single", options:["er liest","er lesen","er las"]},

  // Zeitformen erkennen
  {id:9, points:1, question:"„ich spielte“ steht im …", type:"single", options:["Präteritum","Perfekt","Präsens","Futur I"]},
  {id:10, points:1, question:"„ich habe gespielt“ steht im …", type:"single", options:["Perfekt","Präteritum","Plusquamperfekt","Futur I"]},
  {id:11, points:1, question:"„ich war gegangen“ steht im …", type:"single", options:["Plusquamperfekt","Perfekt","Präteritum","Futur II"]},
  {id:12, points:1, question:"„ich werde spielen“ steht im …", type:"single", options:["Futur I","Präsens","Perfekt","Präteritum"]},
  {id:13, points:1, question:"„ich werde gespielt haben“ steht im …", type:"single", options:["Futur II","Futur I","Perfekt","Plusquamperfekt"]},

  // mehrere Formen zuordnen
  {id:14, points:1, question:"Welche Formen stehen im Perfekt?", type:"multi", options:["ich habe gelernt","ich bin gegangen","ich hatte gelernt","ich werde lernen"]},
  {id:15, points:1, question:"Welche Formen stehen im Plusquamperfekt?", type:"multi", options:["ich hatte gelernt","ich war gegangen","ich werde gelernt haben","ich habe gelernt"]},
  {id:16, points:1, question:"Welche Formen stehen im Präsens?", type:"multi", options:["ich spiele","wir gehen","ich werde gehen","ich spielte"]},
  {id:17, points:1, question:"Welche Sätze stehen im Präteritum?", type:"multi", options:["Er ging nach Hause.","Wir gehen nach Hause.","Sie spielte gestern Klavier.","Ich werde gehen."]},

  // Anwendung / richtige Bildung
  {id:18, points:1, question:"Welche Verbform passt: „Morgen ___ ich dir helfen.“", type:"single", options:["werde","habe","war"]},
  {id:19, points:1, question:"Welche Zeitform drückt Vorzeitigkeit zur Vergangenheit aus?", type:"single", options:["Plusquamperfekt","Perfekt","Futur II"]},
  {id:20, points:1, question:"Welche Variante ist korrekt im Perfekt?", type:"single", options:["Ich habe den Text geschrieben.","Ich habe den Text schreibte.","Ich bin den Text geschrieben."]},
  {id:21, points:1, question:"Setze „fahren“ in Perfekt, 1. Person Plural.", type:"single", options:["Wir sind gefahren.","Wir haben gefahren.","Wir werden fahren."]},
  {id:22, points:1, question:"Welche Kombination ist richtig gebildet?", type:"single", options:["Futur II: Ich werde gegangen sein.","Perfekt: Ich werde gegangen.","Präteritum: Ich bin gegangen."]},

  // Abschluss / gemischt
  {id:23, points:1, question:"Welche Wortarten kommen im Satz „Der alte Mann liest langsam.“ vor?", type:"multi", options:["Artikel","Adjektiv","Nomen","Verb","Adverb"]},
  {id:24, points:1, question:"Welche Sätze enthalten ein Modalverb im Präsens?", type:"multi", options:["Ich kann schwimmen.","Ich schwamm.","Wir mussten gehen.","Er will lesen."]},
  {id:25, points:1, question:"„Am Freitag haben wir Sport gemacht.“ steht im …", type:"single", options:["Perfekt","Präteritum","Futur I"]}
];

// ---------- Antwortschlüssel ----------
const answerKey = {
  1:{type:"single",correct:["Verb"]},
  2:{type:"single",correct:["Adjektiv"]},
  3:{type:"multi",correct:["der Tisch","die Freiheit"]},
  4:{type:"multi",correct:["spielen","singen"]},
  5:{type:"single",correct:["Pronomen"]},
  6:{type:"single",correct:["Wir gehen nach Hause."]},
  7:{type:"single",correct:["werden"]},
  8:{type:"single",correct:["er liest"]},
  9:{type:"single",correct:["Präteritum"]},
  10:{type:"single",correct:["Perfekt"]},
  11:{type:"single",correct:["Plusquamperfekt"]},
  12:{type:"single",correct:["Futur I"]},
  13:{type:"single",correct:["Futur II"]},
  14:{type:"multi",correct:["ich habe gelernt","ich bin gegangen"]},
  15:{type:"multi",correct:["ich hatte gelernt","ich war gegangen"]},
  16:{type:"multi",correct:["ich spiele","wir gehen"]},
  17:{type:"multi",correct:["Er ging nach Hause.","Sie spielte gestern Klavier."]},
  18:{type:"single",correct:["werde"]},
  19:{type:"single",correct:["Plusquamperfekt"]},
  20:{type:"single",correct:["Ich habe den Text geschrieben."]},
  21:{type:"single",correct:["Wir sind gefahren."]},
  22:{type:"single",correct:["Futur II: Ich werde gegangen sein."]},
  23:{type:"multi",correct:["Artikel","Adjektiv","Nomen","Verb","Adverb"]},
  24:{type:"multi",correct:["Ich kann schwimmen.","Er will lesen."]},
  25:{type:"single",correct:["Perfekt"]}
};

// ------------------- Bewertung & Anzeige -------------------
const tasksById = Object.fromEntries(tasks.map(t=>[t.id,t]));
function normalize(s){ return String(s||'').trim().toLowerCase(); }
function arraysEqualAsSets(a,b){
  const A=new Set(a.map(normalize)),B=new Set(b.map(normalize));
  return A.size===B.size && [...A].every(v=>B.has(v));
}
function isCorrect(id,g){
  const spec=answerKey[id]; if(!spec)return false;
  if(spec.type==="multi"){ return arraysEqualAsSets(Array.isArray(g)?g:[], spec.correct); }
  return spec.correct.map(normalize).includes(normalize(g));
}
function autoPoints(id,g){ return isCorrect(id,g) ? (tasksById[id].points||1) : 0; }
function totalMaxPoints(){ return tasks.reduce((s,t)=>s+t.points,0); }

const tasksDiv=document.getElementById("tasks");
tasks.forEach(t=>{
  const d=document.createElement("div"); d.className="task";
  const p=document.createElement("p"); p.textContent=`${t.id}. ${t.question} (${t.points} P)`; d.appendChild(p);
  if(t.type==="single"){
    t.options.forEach(opt=>{
      const l=document.createElement("label");
      const i=document.createElement("input"); i.type="radio"; i.name="a"+t.id; i.value=opt;
      l.appendChild(i); l.append(" "+opt); d.appendChild(l);
    });
  } else if(t.type==="multi"){
    t.options.forEach(opt=>{
      const l=document.createElement("label");
      const i=document.createElement("input"); i.type="checkbox"; i.name="a"+t.id; i.value=opt;
      l.appendChild(i); l.append(" "+opt); d.appendChild(l);
    });
  }
  tasksDiv.appendChild(d);
});
tasksDiv.insertAdjacentHTML("beforeend",`<div class="small">Gesamtpunkte: ${totalMaxPoints()}</div>`);

const submitBtn=document.getElementById("submitBtn"),resultBox=document.getElementById("resultBox");
submitBtn.addEventListener("click",async()=>{
  const name=document.getElementById("studentName").value.trim();
  if(!name)return alert("Bitte Namen eingeben!");
  const answers={};
  for(const t of tasks){
    const key="a"+t.id;
    if(t.type==="multi")answers[key]=[...document.querySelectorAll(`input[name="${key}"]:checked`)].map(x=>x.value);
    else answers[key]=document.querySelector(`input[name="${key}"]:checked`)?.value||"";
  }
  let sum=0; for(const t of tasks){ sum+=autoPoints(t.id,answers["a"+t.id]); }
  const percent=Math.round(sum/totalMaxPoints()*100);
  try{
    await addDoc(collection(db,"submissions"),{
      studentName:name,
      answers,
      score:sum,
      percent,
      createdAt:serverTimestamp()
    });
    resultBox.style.display="block";
    resultBox.innerHTML=`<strong>Abgabe gespeichert:</strong> ${sum}/${totalMaxPoints()} Punkte (${percent} %)`;
  }catch(e){
    console.error(e);
    alert("Fehler beim Speichern.");
  }
});

const TEACHER_PASSWORD="lehrer123";
document.getElementById("loginBtn").addEventListener("click",async()=>{
  if(document.getElementById("teacherPass").value!==TEACHER_PASSWORD){
    document.getElementById("loginMsg").textContent="Falsches Passwort!";
    return;
  }
  document.getElementById("loginArea").style.display="none";
  document.getElementById("teacherPanel").style.display="block";
  const subC=document.getElementById("submissionsContainer");
  let snap;
  try{
    snap=await getDocs(query(collection(db,"submissions"),orderBy("createdAt","desc")));
  }catch{
    snap=await getDocs(collection(db,"submissions"));
  }
  if(snap.empty){ subC.textContent="Keine Einsendungen."; return; }
  let html="<table><tr><th>Name</th><th>Punkte</th><th>%</th></tr>";
  snap.forEach(d=>{
    const x=d.data();
    html+=`<tr><td>${x.studentName}</td><td>${x.score}</td><td>${x.percent}</td></tr>`;
  });
  subC.innerHTML=html+"</table>";
});
</script>
</body>
</html>
