<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wortarten-Test — Lehrerbereich mit Firebase</title>
  <style>
    body{font-family:Inter,system-ui;background:#f4f7fb;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(12,24,48,0.06)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{color:#0b63d6;font-size:20px;margin:0}
    .small{font-size:13px;color:#667}

    /* wieder breiteres Layout */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eaeaea;padding:8px;text-align:left;font-size:13px;vertical-align:top}
    th{background:#f0f4ff}

    button{background:#0b63d6;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:#eef6ff;color:#0b63d6;border:1px solid #d6eaff}
    input[type=password], input[type=text]{padding:8px;border:1px solid #ccc;border-radius:6px;width:240px}
    #teacherPanel{display:none;margin-top:14px;padding:12px;background:#fff8e6;border-radius:8px;border:1px solid #ffecb3}
    .task{margin:12px 0;padding:10px;border:1px solid #eef3ff;border-radius:10px;background:#fbfdff}
    .task p{margin:0 0 6px 0;font-weight:600}
    label{display:block;margin:4px 0}

    /* Anzeige/Editor in Q-Zellen */
    .pts-line{display:flex;align-items:center;gap:6px;margin-top:6px}
    .q-pts-label{font-size:12px;color:#445;white-space:nowrap}
    .q-pts{width:56px;padding:4px 6px;border:1px solid #ccd6e6;border-radius:6px;text-align:center}

    /* Spaltenbreiten (breit) */
    .col-name{width:160px}
    .col-q{min-width:140px;width:140px}
    .col-sum{width:100px}
    .col-pc{width:70px}
    .col-note{width:70px}
    .col-time{width:170px}
    .col-act{width:210px}

    /* Antworten begrenzen, damit nichts überlappt */
    .ans{max-height:64px;overflow:auto}

    .save-btn{background:#16a34a;border:1px solid #b7f0c2;color:#fff;padding:6px 10px;border-radius:8px;margin-left:4px}
    .view-btn{background:#5551ff;border:1px solid #cfd2ff;color:#fff;padding:6px 10px;border-radius:8px;margin-left:4px}
    .edit-btn{background:#0ea5e9;border:1px solid #bfe6fb;color:#fff;padding:6px 10px;border-radius:8px;margin-left:4px}

    /* Modal */
    #modalOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;padding:16px}
    #modalCard{max-width:920px;width:100%;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);padding:16px}
    #modalBody{max-height:70vh;overflow:auto}
    #modalHeader{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    #closeModal{margin-left:auto;background:#e11d48}
    .ok{color:#16a34a;font-weight:600}
    .bad{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Wortarten-Test — Lehrerbereich</h1>
      <div class="small">Abruf aller Einsendungen aus Firebase</div>
    </header>

    <div id="studentArea" style="margin-top:20px;">
      <p>Trage deinen Namen ein und bearbeite die Aufgaben:</p>
      <input type="text" id="studentName" placeholder="Vorname Nachname">
      <div id="tasks"></div>
      <button id="submitBtn">Antworten absenden</button>
      <div id="resultBox" class="small" style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:#f0f7ff;border:1px solid #dbeeff"></div>
    </div>

    <div id="loginArea" style="margin-top:28px;">
      <p>Bitte Passwort eingeben, um den Lehrerbereich zu öffnen:</p>
      <input type="password" id="teacherPass" placeholder="Lehrerpasswort">
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="small" style="color:#b33;margin-top:8px;"></div>
    </div>

    <div id="teacherPanel">
      <div style="display:flex;gap:10px;align-items:center">
        <button id="refreshSub" class="secondary">Aktualisieren</button>
        <button id="exportCsv" class="secondary">Export CSV</button>
        <div class="small" style="margin-left:auto">Neueste zuerst • Einzelpunkte per „Punkte editieren“ bearbeiten</div>
      </div>
      <div id="submissionsContainer" style="margin-top:14px"></div>
    </div>
  </div>

  <!-- Modal für Detailansicht -->
  <div id="modalOverlay">
    <div id="modalCard">
      <div id="modalHeader">
        <h2 style="margin:0;font-size:18px;color:#0b63d6">Abgabe – Detailansicht</h2>
        <button id="closeModal">Schließen</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// ---- Firebase ----
const firebaseConfig = {
  apiKey: "AIzaSyCOWi7ecJR17wzEsm2q6wPR1BZWV-VrDBo",
  authDomain: "hausaufgabe-40294.firebaseapp.com",
  projectId: "hausaufgabe-40294",
  storageBucket: "hausaufgabe-40294.firebasestorage.app",
  messagingSenderId: "275544438191",
  appId: "1:275544438191:web:d68f43e7e43025df76eb5a",
  measurementId: "G-HPGHMYZXNJ"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---- Aufgaben ----
const tasks = [
  {id:1, points:1, question:"Markiere alle Substantive: Der Hund läuft im Park.", type:"multi", options:["Hund","läuft","Park"]},
  {id:2, points:1, question:"Welche Wortart ist 'und'?", type:"single", options:["Verb","Konjunktion","Adjektiv"]},
  {id:3, points:1, question:"Setze ein passendes Adjektiv ein: Der Film war ___.", type:"text"},
  {id:4, points:1, question:"Wähle alle Verben: Sie tanzt und singt im Regen.", type:"multi", options:["tanzt","singt","im"]},
  {id:5, points:1, question:"Bestimme die Wortart: schnell", type:"single", options:["Adjektiv","Adverb","Nomen","Verb"]},
  {id:6, points:1, question:"Synonyme wählen: Welche Wörter bedeuten ungefähr dasselbe wie „wütend“?", type:"multi", options:["zornig","verärgert","rasend","fröhlich","gelassen"]},
  {id:7, points:1, question:"Antonym (Gegenteil): Was ist das Gegenteil von „sparsam“?", type:"single", options:["geizig","verschwenderisch","vorsichtig"]},
  {id:8, points:1, question:"Kollokationen: Was passt zu „eine Entscheidung …“? (alle richtigen auswählen)", type:"multi", options:["treffen","fällen","legen","machen"]},
  {id:9, points:1, question:"Wortbildung mit Präfix: Ergänze so, dass „nicht verständlich“ entsteht: ___verständlich", type:"text"},
  {id:10, points:1, question:"Zusammensetzung: Wie heißt ein Vertrag für das Handy? (Schreibe das zusammengesetzte Nomen.)", type:"text"},
  {id:11, points:1, question:"Welches Wort passt NICHT in die Reihe (Bedeutungsfeld „sprechen“)?", type:"single", options:["plaudern","flüstern","schreien","laufen","reden"]},
  {id:12, points:1, question:"Anglizismen: Welche Wörter sind aus dem Englischen entlehnt und so im Deutschen üblich?", type:"multi", options:["downloaden","chillen","Team","Zeitgeist","Fernsehen"]},
  {id:13, points:1, question:"Redewendung ergänzen: „Jemandem ___ die Sprünge helfen.“", type:"single", options:["auf","über","unter"]},
  {id:14, points:1, question:"Falsche Freunde (Deutsch–Englisch): Welche bedeuten im Deutschen etwas anderes als das ähnlich klingende englische Wort? (alle richtigen auswählen)", type:"multi", options:["eventuell","aktuell","Chef","Gift","Computer"]},
  {id:15, points:1, question:"Treffendstes Wort: „Der Schüler zeigte große ___: Er arbeitete selbstständig und zuverlässig.“", type:"single", options:["Disziplin","Temperatur","Landschaft"]}
];

// ---- Antwortschlüssel ----
const answerKey = {
  1: {type:'multi', correct:["Hund","Park"]},
  2: {type:'single', correct:["Konjunktion"]},
  3: {type:'text', correct:["spannend","langweilig","toll","interessant","fesselnd","schlecht","gut","beeindruckend"]},
  4: {type:'multi', correct:["tanzt","singt"]},
  5: {type:'single', correct:["Adjektiv","Adverb"]},
  6: {type:'multi', correct:["zornig","verärgert","rasend"]},
  7: {type:'single', correct:["verschwenderisch"]},
  8: {type:'multi', correct:["treffen","fällen"]},
  9: {type:'text', correct:["unverständlich"]},
  10:{type:'text', correct:["handyvertrag","mobilfunkvertrag","mobiltelefonvertrag"]},
  11:{type:'single', correct:["laufen"]},
  12:{type:'multi', correct:["downloaden","chillen","team"]},
  13:{type:'single', correct:["auf"]},
  14:{type:'multi', correct:["eventuell","aktuell","chef","gift"]},
  15:{type:'single', correct:["Disziplin"]}
};

// Hilfsstrukturen & Bewertung
const tasksById = Object.fromEntries(tasks.map(t=>[t.id,t]));
function normalize(s){ return String(s||'').trim().toLowerCase(); }
function arraysEqualAsSets(a,b){
  if(a.length!==b.length) return false;
  const A=new Set(a.map(normalize));
  const B=new Set(b.map(normalize));
  if(A.size!==B.size) return false;
  for(const v of A){ if(!B.has(v)) return false; }
  return true;
}
function totalMaxPoints(){ return tasks.reduce((s,t)=>s+(Number(t.points)||0),0); }
function isCorrect(taskId, given){
  const spec = answerKey[taskId];
  if(!spec) return false;
  if(spec.type==='multi'){
    const g = Array.isArray(given)? given.map(normalize) : [];
    return arraysEqualAsSets(g, spec.correct.map(normalize));
  } else if(spec.type==='single'){
    return spec.correct.map(normalize).includes(normalize(given));
  } else {
    return spec.correct.map(normalize).includes(normalize(given));
  }
}
function autoPoints(taskId, given){
  const t = tasksById[taskId];
  return isCorrect(taskId, given) ? (Number(t.points)||0) : 0;
}

// ---- Schüler-Rendering ----
const tasksDiv = document.getElementById('tasks');
function renderTasks(){
  tasksDiv.innerHTML = '';
  tasks.forEach(t=>{
    const div = document.createElement('div');
    div.className='task';
    const p = document.createElement('p');
    const ptsLabel = ` (${t.points} Punkt${t.points===1?'':'e'})`;
    p.textContent = `${t.id}. ${t.question}${ptsLabel}`;
    div.appendChild(p);

    if(t.type==='multi'){
      const opts = [...t.options];
      for(let i=opts.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [opts[i],opts[j]]=[opts[j],opts[i]]; }
      opts.forEach(opt=>{
        const lbl = document.createElement('label');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.name='a'+t.id; cb.value=opt;
        lbl.appendChild(cb); lbl.appendChild(document.createTextNode(' '+opt));
        div.appendChild(lbl);
      });
    } else if(t.type==='single'){
      const opts = [...t.options];
      for(let i=opts.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [opts[i],opts[j]]=[opts[j],opts[i]]; }
      opts.forEach(opt=>{
        const lbl = document.createElement('label');
        const rb = document.createElement('input'); rb.type='radio'; rb.name='a'+t.id; rb.value=opt;
        lbl.appendChild(rb); lbl.appendChild(document.createTextNode(' '+opt));
        div.appendChild(lbl);
      });
    } else {
      const input = document.createElement('input'); input.type='text'; input.name='a'+t.id; input.placeholder='Antwort eingeben';
      div.appendChild(input);
    }

    tasksDiv.appendChild(div);
  });

  const totalPts = totalMaxPoints();
  const info = document.createElement('div');
  info.className = 'small';
  info.style.marginTop = '6px';
  info.textContent = `Gesamtpunkte: ${totalPts}`;
  tasksDiv.appendChild(info);
}
renderTasks();

// ---- Notenschlüssel ----
function gradeFromPercent(p){
  const n = Number(p)||0;
  if(n>=91) return 1;
  if(n>=77) return 2;
  if(n>=57) return 3;
  if(n>=39) return 4;
  if(n>=25) return 5;
  return 6;
}

// ---- Auswertung gesamt ----
function evaluateAll(answers){
  const details=[];
  let sum=0;
  for(const t of tasks){
    const key='a'+t.id;
    const given = answers[key];
    const ok = isCorrect(t.id, given);
    const ptsIfCorrect = Number(t.points)||0;
    const auto = ok ? ptsIfCorrect : 0;
    sum += auto;
    details.push({id:t.id, q:t.question, given, correct:answerKey[t.id].correct, ok, pointsIfCorrect:ptsIfCorrect, autoAward:auto});
  }
  const maxPts = totalMaxPoints();
  const percent = maxPts>0 ? Math.round(sum/maxPts*100) : 0;
  return {points:sum, maxPts, percent, details};
}

// ---- Abgabe (Bestätigung & Lock) ----
const submitBtn = document.getElementById('submitBtn');
const resultBox = document.getElementById('resultBox');
submitBtn.addEventListener('click', handleSubmitClick);

function countUnanswered(){
  let missing=0;
  for(const t of tasks){
    const key='a'+t.id;
    if(t.type==='multi'){
      const vals = Array.from(document.querySelectorAll(`input[name="${key}"]:checked`));
      if(vals.length===0) missing++;
    } else if(t.type==='single'){
      const val = document.querySelector(`input[name="${key}"]:checked`);
      if(!val) missing++;
    } else {
      const val = document.querySelector(`input[name="${key}"]`)?.value.trim();
      if(!val) missing++;
    }
  }
  return missing;
}
function lockStudentForm(){
  document.getElementById('studentName').setAttribute('disabled','disabled');
  tasksDiv.querySelectorAll('input').forEach(el=>el.setAttribute('disabled','disabled'));
  submitBtn.setAttribute('disabled','disabled');
  submitBtn.textContent = 'Abgegeben';
}

async function handleSubmitClick(){
  const name = document.getElementById('studentName').value.trim();
  if(!name){ alert('Bitte Namen eingeben!'); return; }

  const missing = countUnanswered();
  const total = tasks.length;
  const confirmMsg = missing>0
    ? `Du hast ${missing} von ${total} Aufgaben nicht bearbeitet.\nWirklich absenden? Danach kannst du nichts mehr ändern.`
    : `Möchtest du deine Antworten wirklich absenden? Danach kannst du nichts mehr ändern.`;
  if(!confirm(confirmMsg)){ return; }

  lockStudentForm();

  const answers = {};
  for(const t of tasks){
    const key = 'a'+t.id;
    if(t.type==='multi'){
      const vals = Array.from(document.querySelectorAll(`input[name="${key}"]:checked`)).map(c=>c.value);
      answers[key] = vals;
    } else if(t.type==='single'){
      const val = document.querySelector(`input[name="${key}"]:checked`)?.value || '';
      answers[key] = val;
    } else {
      const val = document.querySelector(`input[name="${key}"]`)?.value || '';
      answers[key] = val;
    }
  }

  const evalRes = evaluateAll(answers);

  try{
    await addDoc(collection(db,'submissions'),{
      studentName: name,
      answers,
      score: evalRes.points,
      maxPoints: evalRes.maxPts,
      percent: evalRes.percent,
      createdAt: serverTimestamp(),
      createdAtLocal: new Date().toISOString()
    });

    resultBox.style.display='block';
    let html = `<strong>Abgabe gespeichert</strong> — ${evalRes.points}/${evalRes.maxPts} Punkte (${evalRes.percent}%).`;
    html += `<details style="margin-top:8px"><summary>Antworten & Lösungen ansehen</summary>`;
    evalRes.details.forEach(d=>{
      const given = Array.isArray(d.given)? d.given.join(', ') : (d.given||'(leer)');
      const correct = Array.isArray(d.correct)? d.correct.join(', ') : d.correct;
      html += `<div style="margin-top:6px;padding:8px;border:1px solid #eef3ff;border-radius:8px;background:#fff">`+
              `<div style="font-weight:600">${d.id}. ${d.q} — <span class="small">${d.pointsIfCorrect} Punkt${d.pointsIfCorrect===1?'':'e'})</span></div>`+
              `<div>Deine Antwort: ${escapeHtml(given)} ${d.ok? '<span class="ok">✅ richtig</span>' : '<span class="bad">❌ falsch</span>'}</div>`+
              `<div>Korrekt: ${escapeHtml(String(correct))}</div>`+
              `</div>`;
    });
    html += `</details>`;
    resultBox.innerHTML = html;

  }catch(err){
    console.error('Fehler beim Speichern:', err);
    alert('Fehler beim Speichern. Siehe Konsole.');
    document.getElementById('studentName').removeAttribute('disabled');
    tasksDiv.querySelectorAll('input').forEach(el=>el.removeAttribute('disabled'));
    submitBtn.removeAttribute('disabled');
    submitBtn.textContent = 'Antworten absenden';
  }
}

// ---- Lehrerbereich ----
const TEACHER_PASSWORD='lehrer123';
const loginBtn=document.getElementById('loginBtn');
const loginMsg=document.getElementById('loginMsg');
const teacherPanel=document.getElementById('teacherPanel');
const submissionsContainer=document.getElementById('submissionsContainer');

loginBtn.addEventListener('click',()=>{
  const entered=document.getElementById('teacherPass').value;
  if(entered===TEACHER_PASSWORD){
    document.getElementById('loginArea').style.display='none';
    teacherPanel.style.display='block';
    refreshSubmissions();
  } else {
    loginMsg.textContent='Falsches Passwort!';
  }
});

document.getElementById('refreshSub').addEventListener('click', refreshSubmissions);
document.getElementById('exportCsv').addEventListener('click', exportCsv);

// ---- Lehrer-Tabelle mit „Punkte editieren“-Modus pro Zeile ----
async function refreshSubmissions(){
  submissionsContainer.innerHTML='<div class="small">Lade Einsendungen…</div>';
  try{
    let snap;
    try{
      snap = await getDocs(query(collection(db,'submissions'), orderBy('createdAt','desc')));
    }catch(e){
      console.warn('Fallback ohne orderBy(createdAt):', e);
      snap = await getDocs(collection(db,'submissions'));
    }

    if(snap.empty){ submissionsContainer.innerHTML='<div class="small">Keine Einsendungen gefunden.</div>'; return; }

    const maxPtsNow = totalMaxPoints();

    let html = '<table><thead><tr>';
    html += `<th class="col-name">Name</th>`;
    for(let i=1;i<=tasks.length;i++){ html += `<th class="col-q">Q${i}<br><span class="small">Antwort / P.</span></th>`; }
    html += '<th class="col-sum">Gesamt</th><th class="col-pc">%</th><th class="col-note">Note</th><th class="col-time">Zeit</th><th class="col-act">Aktion</th></tr></thead><tbody>';

    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const id = docSnap.id;

      const ans = d.answers || {};
      const tPts = d.teacherPoints || {}; // { "1": 1, ... }

      let rowHtml = `<tr data-doc="${id}" data-max="${d.maxPoints ?? maxPtsNow}"><td class="col-name">${escapeHtml(d.studentName||'')}</td>`;
      let sumPoints = 0;

      for(let q=1; q<=tasks.length; q++){
        const key = 'a'+q;
        const given = ans[key];
        const givenStr = Array.isArray(given)? given.join(', ') : (given||'');
        const defaultAuto = autoPoints(q, given);
        const value = (tPts[String(q)]!=null) ? tPts[String(q)] : defaultAuto;
        sumPoints += Number(value)||0;
        const ok = isCorrect(q, given);
        const okBadge = ok ? '<span class="ok">✅</span>' : '<span class="bad">❌</span>';

        // Anzeige-Modus (Spans) – Inputs werden erst bei "Punkte editieren" erzeugt
        rowHtml += `<td class="col-q">
          <div class="ans">${escapeHtml(givenStr||'(leer)')} ${okBadge}</div>
          <div class="pts-line">
            <span class="q-pts-label">P:</span>
            <span class="pts-display" data-q="${q}">${String(value)}</span> / <span>${tasksById[q].points}</span>
          </div>
        </td>`;
      }

      const maxPts = d.maxPoints!=null ? d.maxPoints : maxPtsNow;
      const percent = maxPts>0 ? Math.round((sumPoints/maxPts)*100) : 0;
      const note = gradeFromPercent(percent);
      const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate()
                : (d.timestamp && d.timestamp.seconds ? new Date(d.timestamp.seconds*1000)
                : (d.createdAtLocal ? new Date(d.createdAtLocal) : null));

      rowHtml += `<td class="col-sum sum-cell">${escapeHtml(String(sumPoints))}</td>`;
      rowHtml += `<td class="col-pc pc-cell">${escapeHtml(String(percent))}</td>`;
      rowHtml += `<td class="col-note note-cell">${escapeHtml(String(note))}</td>`;
      rowHtml += `<td class="col-time">${ts? escapeHtml(ts.toLocaleString()) : ''}</td>`;
      rowHtml += `<td class="col-act">
        <button class="view-btn" data-doc="${id}">Anzeigen</button>
        <button class="edit-btn" data-doc="${id}" data-mode="view">Punkte editieren</button>
        <button class="save-btn" data-doc="${id}">Speichern</button>
      </td></tr>`;

      html += rowHtml;
    });

    html += '</tbody></table>';
    html += `<div class="small" style="margin-top:8px">Tipp: Erst „Punkte editieren“, dann gewünschte Punkte eintragen und „Speichern“ drücken. „Gesamt“ = Summe der Einzelpunkte.</div>`;
    submissionsContainer.innerHTML = html;

  }catch(err){
    console.error('Ladefehler:',err);
    submissionsContainer.innerHTML = '<div class="small">Fehler beim Laden der Einsendungen. Siehe Konsole.</div>';
  }
}

// Row-Edit-Modus an/aus schalten
function toggleEditMode(row, toEdit){
  const modeBtn = row.querySelector('.edit-btn');
  const displays = row.querySelectorAll('.pts-display');
  if(toEdit){
    // Spans -> Inputs
    displays.forEach(span=>{
      const val = span.textContent.trim();
      const q = span.dataset.q;
      const input = document.createElement('input');
      input.className='q-pts';
      input.type='text';
      input.inputMode='decimal';
      input.value = val;
      input.setAttribute('data-q', q);
      span.replaceWith(input);
    });
    modeBtn.textContent = 'Felder sperren';
    modeBtn.setAttribute('data-mode','edit');
  }else{
    // Inputs -> Spans (ohne Speichern)
    const inputs = row.querySelectorAll('input.q-pts');
    inputs.forEach(inp=>{
      const q = inp.dataset.q;
      const span = document.createElement('span');
      span.className='pts-display';
      span.setAttribute('data-q', q);
      span.textContent = inp.value;
      inp.replaceWith(span);
    });
    modeBtn.textContent = 'Punkte editieren';
    modeBtn.setAttribute('data-mode','view');
  }
}

// Event-Delegation: Anzeigen / Editieren / Speichern
submissionsContainer.addEventListener('click', async (e)=>{
  const viewBtn = e.target.closest('.view-btn');
  const editBtn = e.target.closest('.edit-btn');
  const saveBtn = e.target.closest('.save-btn');
  if(!viewBtn && !editBtn && !saveBtn) return;

  const row = (viewBtn||editBtn||saveBtn).closest('tr');
  const docId = (viewBtn||editBtn||saveBtn).dataset.doc;

  if(viewBtn){
    // Modal mit Details
    const name = row.querySelector('.col-name').textContent;
    let body = `<div class="small">Schüler/in: <strong>${escapeHtml(name)}</strong></div>`;
    body += `<div style="margin-top:6px">`;
    for(let q=1;q<=tasks.length;q++){
      const qCell = row.querySelector(`.col-q:nth-of-type(${q+1})`); // +1 wegen Name-Spalte
      const ansText = qCell.querySelector('.ans')?.textContent || '';
      const ptsVal = qCell.querySelector('.pts-display')?.textContent || qCell.querySelector('.q-pts')?.value || '0';
      body += `<div style="margin:6px 0;padding:8px;border:1px solid #eef3ff;border-radius:8px;background:#fff">
        <div style="font-weight:600">${q}. ${escapeHtml(tasksById[q].question)} <span class="small">(${tasksById[q].points} P)</span></div>
        <div>${escapeHtml(ansText)}</div>
        <div>Punkte: <strong>${escapeHtml(ptsVal)}</strong> / ${tasksById[q].points}</div>
      </div>`;
    }
    body += `</div>`;
    openModal(body);
    return;
  }

  if(editBtn){
    const mode = editBtn.getAttribute('data-mode');
    toggleEditMode(row, mode==='view');
    return;
  }

  if(saveBtn){
    try{
      // Sicherstellen, dass wir Werte aus Inputs holen (wenn gerade im Edit-Modus)
      if(row.querySelector('.edit-btn')?.getAttribute('data-mode')==='edit'){
        // nichts – Inputs sind sichtbar
      }else{
        // in view-Mode -> in Inputs wechseln, direkt wieder zurück? Wir lesen in jedem Fall aktuelle Werte:
      }

      const teacherPoints = {};
      let sum = 0;

      // Wenn Inputs da → aus Inputs lesen, sonst aus Spans
      const inputs = row.querySelectorAll('input.q-pts');
      if(inputs.length){
        for(const inp of inputs){
          const q = inp.dataset.q;
          const val = Number((inp.value||'').toString().replace(',','.'));
          if(Number.isNaN(val) || val<0){ alert(`Bitte gültige Punkte für Q${q} eingeben (≥ 0).`); return; }
          teacherPoints[q] = val;
          sum += val;
        }
      }else{
        const spans = row.querySelectorAll('.pts-display');
        for(const sp of spans){
          const q = sp.dataset.q;
          const val = Number((sp.textContent||'').toString().replace(',','.'));
          if(Number.isNaN(val) || val<0){ alert(`Bitte gültige Punkte für Q${q} eingeben (≥ 0).`); return; }
          teacherPoints[q] = val;
          sum += val;
        }
      }

      const maxPts = totalMaxPoints();
      const percent = maxPts>0 ? Math.round((sum/maxPts)*100) : 0;

      await updateDoc(doc(db,'submissions',docId), {
        teacherPoints,
        score: sum,
        percent,
        maxPoints: maxPts
      });

      // UI aktualisieren
      row.querySelector('.sum-cell').textContent = String(sum);
      row.querySelector('.pc-cell').textContent = String(percent);
      row.querySelector('.note-cell').textContent = String(gradeFromPercent(percent));

      // nach Speichern zurück in Anzeige-Modus
      if(row.querySelector('.edit-btn')?.getAttribute('data-mode')==='edit'){
        toggleEditMode(row, false);
      }
    }catch(err){
      console.error('Fehler beim Speichern:',err);
      alert('Fehler beim Speichern. Siehe Konsole.');
    }
  }
});

// Modal helpers
const modalOverlay = document.getElementById('modalOverlay');
const modalBody = document.getElementById('modalBody');
document.getElementById('closeModal').addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e)=>{ if(e.target===modalOverlay) closeModal(); });
function openModal(html){ modalBody.innerHTML = html; modalOverlay.style.display='flex'; }
function closeModal(){ modalOverlay.style.display='none'; modalBody.innerHTML=''; }

// CSV-Export
async function exportCsv(){
  try{
    let snap;
    try{ snap = await getDocs(query(collection(db,'submissions'), orderBy('createdAt','desc'))); }
    catch(e){ console.warn('CSV-Fallback ohne orderBy:',e); snap = await getDocs(collection(db,'submissions')); }

    if(snap.empty){ alert('Keine Einsendungen.'); return; }

    const maxPtsNow = totalMaxPoints();

    const rows = [['Name', ...Array.from({length:tasks.length},(_,i)=>`Q${i+1}`), 'Punkte', 'maxPunkte', 'Prozent', 'Note', 'Timestamp']];
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const row = [d.studentName || ''];
      for(let i=1;i<=tasks.length;i++){
        const v = d.answers ? d.answers['a'+i] : '';
        row.push(Array.isArray(d.answers['a'+i])? d.answers['a'+i].join('; ') : (v||''));
      }
      const maxPts = d.maxPoints!=null ? d.maxPoints : maxPtsNow;
      const pts = d.score!=null? d.score : '';
      const pc = d.percent!=null? d.percent : (maxPts>0 && pts!=='' ? Math.round(Number(pts)/maxPts*100) : '');
      const note = pc!=='' ? gradeFromPercent(pc) : '';
      const ts = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString()
               : (d.timestamp && d.timestamp.seconds ? new Date(d.timestamp.seconds*1000).toISOString()
               : (d.createdAtLocal || ''));
      row.push(pts);
      row.push(maxPts);
      row.push(pc);
      row.push(note);
      row.push(ts);
      rows.push(row);
    });

    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='einsendungen_wortarten.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),4000);
  }catch(err){
    console.error('Exportfehler:',err); alert('Fehler beim Export. Siehe Konsole.');
  }
}

// Utils
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
</script>
</body>
</html>
