<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wortarten-Training – überarbeitete Version</title>
<style>
  :root{--brand:#1f4ea8; --bg:#f6f8fb}
  body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:#112; margin:0; padding:18px;}
  .wrap{max-width:1100px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(15,30,60,0.06)}
  h1{color:var(--brand);margin-top:0}
  .meta{font-size:13px;color:#556; margin-bottom:8px;}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input[type=text]{padding:8px;border:1px solid #cbd5e1;border-radius:6px;width:320px}
  button{background:var(--brand);color:#fff;border:0;padding:9px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#eef3ff;color:#0b3a8a;border:1px solid #d6e4ff}
  .question{padding:12px;border-radius:8px;background:#fbfdff;border:1px solid #eef6ff;margin:12px 0}
  .q-title{font-weight:600;margin-bottom:6px}
  select,input[type=radio]{margin-top:6px}
  .resultBox{padding:12px;border-radius:8px;background:#f0f7ff;border:1px solid #dbeeff;margin-top:12px}
  .student-review{margin-top:8px}
  .ok{color:green;font-weight:700}
  .bad{color:#b02a2a;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eef3ff;text-align:left}
  .teacher-panel{background:#fff8e6;border:1px solid #fff0c4;padding:12px;border-radius:8px;margin-top:12px}
  .small{font-size:13px;color:#556}
  details{margin-top:8px}
  .explain{font-size:13px;color:#333;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Wortarten-Training — 9. Klasse (ohne Interjektionen)</h1>
    <div class="meta">50 Aufgaben • verschiedene Formate • mindestens 8 Übungen zu Relativ- & Demonstrativpronomen • Passw. für Lehrerbereich (nicht sichtbar)</div>

    <div class="row" style="align-items:center">
      <input id="studentName" type="text" placeholder="Name oder Kürzel (z. B. ML oder S14)">
      <div class="small">Bitte Kürzel verwenden, wenn anonym gewünscht.</div>
    </div>

    <form id="quizForm" style="margin-top:14px"></form>

    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="submitBtn">Abgeben & Auswerten</button>
      <button id="clearBtn" type="button" class="secondary">Formular zurücksetzen</button>
      <button id="teacherBtn" type="button" class="secondary">Lehrerbereich (Passwort)</button>
      <div class="small" style="margin-left:auto">Hinweis: Leere Antworten werden nicht als richtig gezählt.</div>
    </div>

    <div id="result" class="resultBox" style="display:none"></div>

    <!-- Lehrerbereich -->
    <div id="teacherView" style="display:none; margin-top:14px">
      <div class="teacher-panel">
        <div style="display:flex;align-items:center;gap:8px">
          <strong>Lehrerbereich</strong>
          <button id="closeTeacher" class="secondary" style="margin-left:auto">Schließen</button>
        </div>
        <div id="teacherControls" style="margin-top:10px">
          <button id="showAll" class="secondary">Alle Einsendungen anzeigen</button>
          <button id="exportCsv" class="secondary">Export CSV</button>
          <button id="clearData" class="secondary">Alle Einsendungen löschen</button>
        </div>
        <div id="submissions" style="margin-top:12px"></div>
      </div>
    </div>

  </div>

<script>
/* ---------------- CONFIG ---------------- */
const TEACHER_PASSWORD = "lehrer123"; // bleibt nur im Code, nicht sichtbar in UI
const STORAGE_KEY = "wortarten_v2_submissions";

/* ---------------- UTILITY ---------------- */
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------------- QUIZ DEFINITION (50) ----------------
   Each item: { id, type:"select"|"text"|"radio", q, options?, a: array of correct values (normalized lowercase), explain: optional }
   - options present for select/radio; they will be shuffled
   - correct answers are checked case-insensitive, trimmed
*/
const rawQuiz = [
  /* 1-8 Nomen/Verben/Adjektive/Adverb: sensible distractors */
  {id:1, type:"text", q:"1) Welches Wort ist ein Nomen? „Der Hund bellt laut.“", a:["hund"], explain:"Hund ist ein Nomen (Konkreta: ein Tier)."},
  {id:2, type:"text", q:"2) Welches Wort ist ein Verb? „Sie rennt schnell.“", a:["rennt"], explain:"rennt drückt eine Tätigkeit aus → Verb."},
  {id:3, type:"text", q:"3) Welches Wort ist ein Adjektiv? „Das Haus ist groß.“", a:["groß"], explain:"groß beschreibt das Nomen → Adjektiv."},
  {id:4, type:"text", q:"4) Welches Wort ist ein Adverb? „Er spricht leise.“", a:["leise"], explain:"leise beschreibt, wie gesprochen wird → Adverb."},
  {id:5, type:"select", q:"5) Welche Wortart ist „freundlich“? (Wähle aus)", options:["Adjektiv","Adverb","Substantiv","Verb"], a:["adjektiv"], explain:"freundlich ist ein Eigenschaftswort → Adjektiv."},
  {id:6, type:"select", q:"6) Welche Wortart ist „laufen“? (Wähle aus)", options:["Verb","Adjektiv","Substantiv","Konjunktion"], a:["verb"], explain:"laufen ist eine Tätigkeit → Verb."},
  {id:7, type:"select", q:"7) Welche Wortart ist „Mutter“? (Wähle aus)", options:["Substantiv","Adjektiv","Pronomen","Artikel"], a:["substantiv"], explain:"Mutter ist ein Nomen / Substantiv."},
  {id:8, type:"select", q:"8) Welche Wortart ist „gestern“? (Wähle aus)", options:["Adverb","Adjektiv","Präposition","Konjunktion"], a:["adverb"], explain:"gestern gibt eine Zeitangabe → Adverb."},

  /* 9-16 Präpositionen mit sinnvollen Alternativen */
  {id:9, type:"select", q:"9) Wähle die richtige Präposition: „Das Buch liegt ___ dem Tisch.“", options:["auf","während","aber","weil"], a:["auf"], explain:"auf zeigt räumliche Beziehung → Präposition."},
  {id:10, type:"select", q:"10) Wähle die richtige Präposition: „Er geht ___ die Brücke.“ (im Sinne von überqueren)", options:["über","und","sehr","der"], a:["über"], explain:"über drückt Richtung/Ort aus → Präposition."},
  {id:11, type:"select", q:"11) Wähle die richtige Präposition: „Sie kommt ___ dem Bahnhof.“ (Ort)", options:["vom","weil","denn","aber"], a:["vom","von"], explain:"vom = von dem (Präposition + Artikel) zeigt Herkunft/Ort."},
  {id:12, type:"select", q:"12) Welche Wortart ist „neben“ in: „Er sitzt neben ihr.“", options:["Präposition","Adverb","Konjunktion","Adjektiv"], a:["präposition"], explain:"neben verbindet Ort mit Nomen → Präposition."},

  /* 13-20 Konjunktionen mit plausiblen Ablenkungen */
  {id:13, type:"select", q:"13) Welche Wortart ist „aber“?", options:["Konjunktion","Adverb","Präposition","Artikel"], a:["konjunktion"], explain:"aber verbindet Hauptsätze/Teilsätze → Konjunktion."},
  {id:14, type:"select", q:"14) Welche Wortart ist „denn“?", options:["Konjunktion","Adverb","Nomen","Präposition"], a:["konjunktion"], explain:"denn ist eine nebenordnende Konjunktion."},
  {id:15, type:"select", q:"15) Welche Wortart ist „weil“?", options:["Konjunktion","Nomen","Adjektiv","Präposition"], a:["konjunktion"], explain:"weil leitet Nebensätze ein → Konjunktion."},
  {id:16, type:"select", q:"16) Welche Wortart ist „und“?", options:["Konjunktion","Adverb","Artikel","Pronomen"], a:["konjunktion"], explain:"und verbindet Wörter/Sätze → Konjunktion."},

  /* 17-24 Artikel & Numerale (mit plausiblen ähnlichen Wörtern) */
  {id:17, type:"select", q:"17) Welches Wort ist ein Artikel? „___ Haus ist groß.“", options:["Das","Haus","Groß","Laufen"], a:["das"], explain:"Das ist ein bestimmter Artikel."},
  {id:18, type:"select", q:"18) Welches Wort ist ein Artikel? „Ich sehe ___ Hund.“ (Akk.)", options:["einen","laufen","groß","er"], a:["einen"], explain:"einen ist unbestimmter Artikel im Akkusativ."},
  {id:19, type:"select", q:"19) Welches Wort ist ein Numerale? „Sie hat ___ Äpfel.“", options:["zwei","bald","viele","groß"], a:["zwei","viele"], explain:"zwei = Zahl (Numerale); 'viele' zählt man zu Indefinitpronomen/Numerale depending, wir akzeptieren 'viele'."},
  {id:20, type:"select", q:"20) Welche Wortart ist „drei“?", options:["Numerale","Adjektiv","Verb","Präposition"], a:["numerale"], explain:"drei ist eine Zahl → Numerale."},

  /* 21-36 Pronomen-Aufgaben (mind. 8 zur Wahl relativ/demonstrativ + Klassifikation) */
  {id:21, type:"select", q:"21) In: „Dieses Haus gefällt mir.“ — Ist 'Dieses' ein Relativ- oder Demonstrativpronomen?", options:["Demonstrativpronomen","Relativpronomen"], a:["demonstrativpronomen"], explain:"Dieses weist demonstrativ auf das Haus hin → Demonstrativpronomen."},
  {id:22, type:"select", q:"22) In: „Der Mann, der dort steht, winkt.“ — Ist 'der' Relativ- oder Demonstrativpronomen?", options:["Relativpronomen","Demonstrativpronomen"], a:["relativpronomen"], explain:"der leitet den Relativsatz ein → Relativpronomen."},
  {id:23, type:"select", q:"23) In: „Jenes Auto ist teuer.“ — Ist 'Jenes' Relativ- oder Demonstrativpronomen?", options:["Demonstrativpronomen","Relativpronomen"], a:["demonstrativpronomen"], explain:"Jenes zeigt auf ein bestimmtes Objekt → Demonstrativpronomen."},
  {id:24, type:"select", q:"24) In: „Die Frau, die singt, ist meine Lehrerin.“ — Ist 'die' relativ oder demonstrativ?", options:["Relativpronomen","Demonstrativpronomen"], a:["relativpronomen"], explain:"die leitet Relativsatz ein → Relativpronomen."},
  {id:25, type:"select", q:"25) Wähle die Pronomenart: ‚Er fährt mit seinem Fahrrad.‘ → 'seinem' ist ...", options:["Possessivpronomen","Personalpronomen","Relativpronomen","Demonstrativpronomen"], a:["possessivpronomen"], explain:"seinem zeigt Besitz → Possessivpronomen."},
  {id:26, type:"select", q:"26) Wähle die Pronomenart: ‚Wir sehen uns.‘ → 'Wir' ist ...", options:["Personalpronomen","Possessivpronomen","Relativpronomen","Demonstrativpronomen"], a:["personalpronomen"], explain:"Wir = Personalpronomen."},
  {id:27, type:"select", q:"27) Wähle die Pronomenart: ‚Das ist mein Buch.‘ → 'mein' ist ...", options:["Possessivpronomen","Demonstrativpronomen","Relativpronomen","Personalpronomen"], a:["possessivpronomen"], explain:"mein zeigt Besitz → Possessivpronomen."},
  {id:28, type:"select", q:"28) Wähle die Pronomenart: ‚Der Mann, der spricht, ist alt.‘ → das zweite 'der' ist ...", options:["Relativpronomen","Demonstrativpronomen","Personalpronomen","Possessivpronomen"], a:["relativpronomen"], explain:"Leitet Relativsatz → Relativpronomen."},
  {id:29, type:"select", q:"29) In: 'Dieses ist das schönere Bild.' → 'Dieses' ist ...", options:["Demonstrativpronomen","Relativpronomen","Personalpronomen","Possessivpronomen"], a:["demonstrativpronomen"], explain:"Demonstrativ: zeigt hin."},
  {id:30, type:"select", q:"30) In: 'Wer das Buch liest, versteht es.' → 'Wer' ist ...", options:["Relativpronomen","Personalpronomen","Demonstrativpronomen","Possessivpronomen"], a:["relativpronomen"], explain:"Leitet Relativsatz bzw. Indefinit; zählt hier zu Relativ/Interrogativformen."},

  /* 31-40 Gemischt, anspruchsvoller: Kontext sinnvoll */
  {id:31, type:"text", q:"31) Finde die Präposition in diesem Satz: ‚Wir treffen uns nach dem Unterricht.‘", a:["nach"], explain:"nach ist Präposition (zeitlich)."},
  {id:32, type:"text", q:"32) Finde das Adverb in: ‚Er arbeitet sehr konzentriert.‘", a:["sehr","konzentriert"], explain:"sehr stärkt das Adjektiv/Adverb; konzentriert hier als Adverbialwort."},
  {id:33, type:"select", q:"33) Welche Wortart ist 'denn' in 'Er bleibt, denn er ist krank.'?", options:["Konjunktion","Adverb","Präposition","Partikel"], a:["konjunktion"], explain:"denn verbindet begründend → Konjunktion."},
  {id:34, type:"text", q:"34) Nenne die Wortart von 'ihrem' in 'Sie gibt ihrem Freund das Buch.'", a:["possessivpronomen","pronomen"], explain:"ihrem zeigt Besitz → Possessivpronomen."},
  {id:35, type:"select", q:"35) Ist 'dieser' in 'Dieser Hund bellt.' Demonstrativ- oder Relativpronomen?", options:["Demonstrativpronomen","Relativpronomen"], a:["demonstrativpronomen"], explain:"dieser zeigt auf etwas Bestimmtes → Demonstrativpronomen."},
  {id:36, type:"select", q:"36) Ist 'welcher' in 'Der Mann, welcher dort steht, ...' Relativ- oder Demonstrativpronomen?", options:["Relativpronomen","Demonstrativpronomen"], a:["relativpronomen"], explain:"welcher leitet Relativsatz → Relativpronomen."},
  {id:37, type:"text", q:"37) Finde das Substantiv: 'Die Freude war groß.'", a:["freude"], explain:"Freude ist ein Gefühl → Nomen."},
  {id:38, type:"text", q:"38) Finde das Verb: 'Er hat das Fahrrad repariert.'", a:["hat","repariert","repariert hat"], explain:"hat + Partizip = zusammengesetzte Verbform (Perfekt). Accept 'hat' or 'repariert'."},
  {id:39, type:"select", q:"39) Welche Wortart ist 'viele' in 'Viele Schüler kommen.'?", options:["Indefinitpronomen/Numerale","Adjektiv","Verb","Artikel"], a:["indefinitpronomen/numerale","numerale","pronomen"], explain:"viele = Mengeangabe; zählt als Indefinitpronomen/Numerale (akzeptiert 'numerale'/'pronomen')."},
  {id:40, type:"select", q:"40) Welcher Wortart gehört 'gerne' an?", options:["Adverb","Adjektiv","Verb","Präposition"], a:["adverb"], explain:"gerne beschreibt eine Handlung → Adverb."},

  /* 41-50 Abschluss: präzise Unterscheidungen, Sätze mit Pronomen-Erkennung */
  {id:41, type:"select", q:"41) In: 'Er, der fleißig übt, besteht.' — Was ist das erste 'Er'?", options:["Personalpronomen","Demonstrativpronomen","Relativpronomen","Possessivpronomen"], a:["personalpronomen"], explain:"Er ist Personalpronomen."},
  {id:42, type:"select", q:"42) In: 'Das Buch, das ich lese, ist spannend.' — Was ist 'das' im Relativsatz?", options:["Relativpronomen","Demonstrativpronomen","Personalpronomen","Artikel"], a:["relativpronomen"], explain:"Leitet Relativsatz ein → Relativpronomen."},
  {id:43, type:"select", q:"43) In: 'Dieses hier gefällt mir.' — 'Dieses' ist ...", options:["Demonstrativpronomen","Personalpronomen","Possessivpronomen","Relativpronomen"], a:["demonstrativpronomen"], explain:"zeigt auf ein bestimmtes Objekt → Demonstrativpronomen."},
  {id:44, type:"text", q:"44) Finde das passende Pronomen (Personal): '___ geht nach Hause.' (Setze das Pronomen ein)", a:["er","sie","wir","ich"], explain:"je nach Kontext 'Er'/'Sie' etc., akzeptieren 'er','sie','wir','ich' (lowercase ok)"},
  {id:45, type:"select", q:"45) Ist 'dessen' in 'Der Mann, dessen Auto kaputt ist...' ein Possessiv- oder Relativpronomen?", options:["Possessiv (Possessivpronomen)","Relativpronomen"], a:["possessiv (possessivpronomen)","possessivpronomen"], explain:"dessen zeigt Besitz und leitet Relativkonstruktion → Possessivpronomen im Relativsatz."},
  {id:46, type:"text", q:"46) Welche Wortart?: 'Von wegen!' → was ist 'von' hier?", a:["präposition"], explain:"von ist Präposition."},
  {id:47, type:"select", q:"47) Welche Wortart ist 'niemand'?", options:["Pronomen","Adjektiv","Adverb","Konjunktion"], a:["pronomen"], explain:"niemand ersetzt ein Nomen → Pronomen."},
  {id:48, type:"text", q:"48) Finde das Adjektiv: 'Ein warmer Sommer beginnt.'", a:["warm","warmer"], explain:"warm/warmer beschreibt Sommer → Adjektiv."},
  {id:49, type:"select", q:"49) Welche Wortart ist 'sowie' (z. B. 'Er mag Fußball sowie Tennis')?", options:["Konjunktion","Adverb","Präposition","Partikel"], a:["konjunktion"], explain:"sowie verbindet zwei Satzteile → Konjunktion."},
  {id:50, type:"text", q:"50) Finde das Pronomen und bestimme die Art: 'Das ist sein Buch.' (Antwortformat: 'sein - Possessivpronomen')", a:["sein - possessivpronomen","sein - possesivpronomen","sein - possessiv"], explain:"Erwartet: 'sein' als Possessivpronomen."}
];

/* Normalize 'a' arrays to lowercase strings for checking */
const quiz = rawQuiz.map(item=>{
  return {...item, a: item.a.map(x=>String(x).toLowerCase())};
});

/* ---------------- RENDER QUIZ ---------------- */
function createOptionElement(value){
  const opt = document.createElement('option');
  opt.value = value;
  opt.textContent = value;
  return opt;
}

function buildQuestion(item){
  const wrapper = document.createElement('div');
  wrapper.className = 'question';
  const title = document.createElement('div'); title.className='q-title'; title.textContent = item.q;
  wrapper.appendChild(title);

  if(item.type === 'text'){
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.id = 'q' + item.id;
    inp.placeholder = 'Antwort hier eingeben';
    wrapper.appendChild(inp);
  } else if(item.type === 'select'){
    const sel = document.createElement('select');
    sel.id = 'q' + item.id;
    // default empty
    sel.appendChild(createOptionElement('')); 
    // shuffle options before adding to avoid always-first correct
    const opts = shuffleArray([...item.options]);
    opts.forEach(o => sel.appendChild(createOptionElement(o)));
    wrapper.appendChild(sel);
  } else if(item.type === 'radio'){
    // (not used in this dataset, but left for extensibility)
    const opts = shuffleArray([...item.options]);
    opts.forEach(o=>{
      const label = document.createElement('label');
      label.style.display='block';
      const r = document.createElement('input');
      r.type='radio'; r.name='q'+item.id; r.value=o;
      label.appendChild(r); label.append(' '+o);
      wrapper.appendChild(label);
    });
  }
  // explanation hidden (to show on review)
  if(item.explain){
    const expl = document.createElement('div');
    expl.className='explain';
    expl.style.display='none';
    expl.id = 'explain-'+item.id;
    expl.textContent = item.explain;
    wrapper.appendChild(expl);
  }

  return wrapper;
}

function renderQuiz(){
  const form = document.getElementById('quizForm');
  form.innerHTML = '';
  quiz.forEach(q => form.appendChild(buildQuestion(q)));
}

/* ---------------- EVALUATION ---------------- */
function getAnswer(item){
  const el = document.getElementById('q'+item.id);
  if(!el) return '';
  return el.value.trim();
}

/* Strict check: answer must match one of accepted strings (case-insensitive).
   For items that accept multiple correct answers (e.g. ["zwei","viele"]), any match is OK.
*/
function isCorrect(item, studentRaw){
  const s = String(studentRaw || '').toLowerCase().trim();
  if(!s) return false; // empty answers are incorrect
  // direct match against any accepted answer
  for(const acc of item.a){
    // allow minor variants: accept 'vom' if expected 'von' etc.  but we won't do fuzzy here except simple contains
    if(s === acc) return true;
    if(s.includes(acc) && acc.length>2) return true; // allow "repariert hat" matching "repariert"
  }
  return false;
}

function evaluateAndSave(){
  const name = document.getElementById('studentName').value.trim() || '---';
  // Build results details
  let points=0; const total = quiz.length;
  const perQuestion = [];
  quiz.forEach(item=>{
    const ansRaw = getAnswer(item);
    const ok = isCorrect(item, ansRaw);
    if(ok) points++;
    perQuestion.push({id:item.id, q:item.q, answer:ansRaw, correct:item.a, ok});
  });

  // Save to localStorage
  const subs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const record = {name, timestamp:new Date().toISOString(), points, total, percent: Math.round(points/total*100), details:perQuestion};
  subs.push(record);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(subs));

  // Show student review
  showStudentResult(record);
}

function showStudentResult(record){
  const r = document.getElementById('result');
  r.style.display='block';
  let html = `<strong>Ergebnis für ${escapeHtml(record.name)}</strong><div class="small">Punkte: ${record.points} / ${record.total} — ${record.percent}%</div>`;
  html += `<div class="student-review"><details><summary>Antworten ansehen (zum Nachbesprechen)</summary><div style="margin-top:8px">`;
  record.details.forEach(d=>{
    const correctStr = d.correct.join(', ');
    const given = d.answer? escapeHtml(d.answer) : '<span class="small">(keine Antwort)</span>';
    const flag = d.ok ? '<span class="ok">Richtig</span>' : '<span class="bad">Falsch</span>';
    html += `<div style="margin-bottom:8px;padding:8px;border-radius:6px;background:#fff;border:1px solid #eef6ff">
               <div style="font-weight:600">${escapeHtml(d.q)}</div>
               <div style="margin-top:6px">Gewählt: ${given} — ${flag}</div>
               <div style="margin-top:6px;color:#334">${'Korrekt: '+escapeHtml(correctStr)}</div>
               ${getExplainHtml(d.id)}
             </div>`;
  });
  html += `</div></details></div>`;
  r.innerHTML = html;
  r.scrollIntoView({behavior:'smooth'});
}

function getExplainHtml(qid){
  const item = quiz.find(x=>x.id===qid);
  if(item && item.explain){
    return `<div style="margin-top:6px;color:#556;font-size:13px">Hinweis: ${escapeHtml(item.explain)}</div>`;
  }
  return '';
}

/* ---------------- TEACHER VIEW ---------------- */
document.getElementById('teacherBtn').addEventListener('click', ()=>{
  // prompt for password (not visible on page)
  const pw = prompt('Bitte Passwort für Lehrerbereich eingeben:');
  if(pw === TEACHER_PASSWORD){
    document.getElementById('teacherView').style.display='block';
    refreshSubmissions();
  } else {
    alert('Falsches Passwort.');
  }
});

document.getElementById('closeTeacher').addEventListener('click', ()=>{
  document.getElementById('teacherView').style.display='none';
});

/* show all submissions in table */
function refreshSubmissions(){
  const subs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const container = document.getElementById('submissions');
  if(!subs.length){ container.innerHTML = '<div class="small">Keine Einsendungen vorhanden.</div>'; return; }
  let html = '<table><thead><tr><th>Name</th><th>Zeit</th><th>Punkte</th><th>%</th><th>Details</th></tr></thead><tbody>';
  subs.slice().reverse().forEach((s, idx)=>{
    const i = subs.length-1-idx;
    html += `<tr><td>${escapeHtml(s.name)}</td><td>${escapeHtml(new Date(s.timestamp).toLocaleString())}</td><td>${s.points}/${s.total}</td><td>${s.percent}%</td><td><button class="secondary" data-i="${i}" onclick="showSubmissionDetails(${i})">Anzeigen</button></td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* show single submission details (alert or modal style) */
window.showSubmissionDetails = function(index){
  const subs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const rec = subs[index];
  if(!rec) return alert('Eintrag nicht gefunden.');
  let text = `Name: ${rec.name}\nZeit: ${new Date(rec.timestamp).toLocaleString()}\nPunkte: ${rec.points}/${rec.total} (${rec.percent}%)\n\nDetails:\n`;
  rec.details.forEach(d=>{
    text += `\nQ: ${d.q}\nGewählt: ${d.answer || '(keine Antwort)'}\nKorrekt: ${d.correct.join(', ')}\n${d.ok? 'Richtig' : 'Falsch'}\n`;
  });
  // show as prompt-like window; for longer text we can open a new window
  const w = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
  w.document.title = 'Einsendungsdetails';
  w.document.body.style.fontFamily='Arial, sans-serif';
  w.document.body.innerHTML = `<pre style="white-space:pre-wrap">${escapeHtml(text)}</pre>`;
}

/* export CSV */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const subs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  if(!subs.length) return alert('Keine Einsendungen.');
  const rows=[["Name","Timestamp","Punkte","Total","Prozent","DetailsJSON"]];
  subs.forEach(s=>rows.push([s.name,s.timestamp,s.points,s.total,s.percent,JSON.stringify(s.details)]));
  const csv = rows.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='wortarten_einsendungen.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
});

/* clear data */
document.getElementById('clearData').addEventListener('click', ()=>{
  if(confirm('Alle lokalen Einsendungen löschen? Diese Aktion ist endgültig.')){ localStorage.removeItem(STORAGE_KEY); refreshSubmissions(); alert('Gelöscht.'); }
});

/* showAll button */
document.getElementById('showAll').addEventListener('click', refreshSubmissions);

/* reset form */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Alle Eingaben zurücksetzen?')) renderQuiz();
});

/* submit handler */
document.getElementById('submitBtn').addEventListener('click', ()=>{
  // ensure students didn't accidentally submit empty form quickly: warn if >60% answers empty
  const total = quiz.length;
  let empty = 0;
  quiz.forEach(it=>{ if(!getAnswer(it)) empty++; });
  if(empty/total > 0.6){
    if(!confirm(`Du hast ${empty} von ${total} Fragen leer gelassen. Willst du trotzdem abschicken?`)) return;
  }
  evaluateAndSave();
});

/* ---------------- INIT ---------------- */
renderQuiz();
</script>
</body>
</html>
